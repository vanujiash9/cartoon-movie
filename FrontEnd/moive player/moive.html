<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>John Wick: Chapter 3 - Parabellum | Maxion</title>
    <link rel="stylesheet" href="../moive player/moive.css">
<!--     
    <style>
        
        
    </style> -->
</head>
<body>
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Header -->
    <header class="header" id="header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">
                <span>‚Üê</span>
                <span>Quay l·∫°i</span>
            </button>
            
            <a href="../index.html" class="logo">MAXION</a>
            <style>
                a{
                     text-decoration: none;
                }
            </style>
            
            <div class="header-actions">
                <button class="action-btn" onclick="toggleTheaterMode()" title="Ch·∫ø ƒë·ªô r·∫°p">
                    <span id="theaterIcon">‚õ∂</span>
                </button>
                <button class="action-btn" onclick="togglePictureInPicture()" title="Picture in Picture">
                    <span>‚ßâ</span>
                </button>
                <button class="action-btn" onclick="toggleQuality()" title="Ch·∫•t l∆∞·ª£ng video">
                    <span>‚öô</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Video Container -->
    <div class="video-container" id="videoContainer">
        <div class="video-player" id="videoPlayer">
            <video class="video-element" id="videoElement" preload="metadata">
                <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                <track kind="captions" src="" srclang="vi" label="Ti·∫øng Vi·ªát">
                <track kind="captions" src="" srclang="en" label="English">
                Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª video.
            </video>

            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner"></div>
            </div>

            <!-- Quality Selector -->
            <div class="quality-selector" id="qualitySelector">
                <button class="quality-option" onclick="changeQuality('4K')">4K Ultra HD</button>
                <button class="quality-option active" onclick="changeQuality('1080p')">1080p Full HD</button>
                <button class="quality-option" onclick="changeQuality('720p')">720p HD</button>
                <button class="quality-option" onclick="changeQuality('480p')">480p</button>
                <button class="quality-option" onclick="changeQuality('360p')">360p</button>
                <button class="quality-option" onclick="changeQuality('auto')">T·ª± ƒë·ªông</button>
            </div>

            <!-- Video Controls -->
            <div class="video-controls" id="videoControls">
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-filled" id="progressFilled"></div>
                        <div class="progress-thumb" id="progressThumb"></div>
                    </div>
                </div>

                <div class="controls-bottom">
                    <div class="controls-left">
                        <button class="control-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()">
                            <span id="playIcon">‚ñ∂</span>
                        </button>
                        
                        <div class="volume-container">
                            <button class="control-btn" id="muteBtn" onclick="toggleMute()">
                                <span id="volumeIcon">üîä</span>
                            </button>
                            <div class="volume-slider" id="volumeSlider">
                                <div class="volume-filled" id="volumeFilled"></div>
                            </div>
                        </div>

                        <div class="time-display" id="timeDisplay">
                            00:00 / 00:00
                        </div>
                    </div>

                    <div class="controls-right">
                        <button class="control-btn" onclick="changePlaybackSpeed()" title="T·ªëc ƒë·ªô ph√°t">
                            <span id="speedIcon">1x</span>
                        </button>
                        
                        <button class="control-btn" onclick="toggleSubtitles()" title="Ph·ª• ƒë·ªÅ">
                            <span>CC</span>
                        </button>
                        
                        <button class="control-btn" onclick="toggleFullscreen()" title="To√†n m√†n h√¨nh">
                            <span id="fullscreenIcon">‚õ∂</span>
                        </button>
                    </div>
                </div>            </div>
        </div>
    </div>

    <!-- Current Episode Info -->
    <div class="current-episode-info">
        <h3 class="current-episode-title">ƒêang t·∫£i...</h3>
    </div>

    <!-- Picture in Picture Container -->
    <div class="pip-container" id="pipContainer">
        <video class="pip-video" id="pipVideo"></video>
        <div class="pip-controls">
            <button class="pip-btn" onclick="closePiP()">√ó</button>
        </div>
    </div>

    <!-- Content Section -->
    <div class="content-section" id="contentSection">
        <div class="movie-info">
            <div class="movie-details">                <h1>John Wick: Chapter 3 - Parabellum</h1>
                
                <p class="description">
                    John Wick b·ªã truy n√£ v·ªõi m·ª©c ti·ªÅn th∆∞·ªüng 14 tri·ªáu ƒë√¥ la tr√™n ƒë·∫ßu v√† m·ªôt ƒë·ªôi qu√¢n s√°t th·ªß ƒëang truy ƒëu·ªïi anh ta. Sau khi gi·∫øt m·ªôt th√†nh vi√™n c·ªßa High Table - t·ªï ch·ª©c s√°t th·ªß b√≠ m·∫≠t qu·ªëc t·∫ø, John Wick b·ªã tr·ª•c xu·∫•t kh·ªèi m·ªçi d·ªãch v·ª• v√† c·∫£nh b√°o trong ng√†nh. Anh ta ph·∫£i chi·∫øn ƒë·∫•u ƒë·ªÉ tho√°t kh·ªèi New York khi m√† c√°c s√°t th·ªß gi·ªèi nh·∫•t th·∫ø gi·ªõi ƒëang sƒÉn l√πng anh.
                </p>

                <!-- Movie Meta Information -->
                <div class="movie-meta" id="movieMeta">                    <div class="meta-item rating">
                        <span>‚≠ê</span>
                        <span id="movieRating">7.4</span>
                        <span id="reviewCount" style="font-size: 0.9em; opacity: 0.8;"></span>
                    </div>
                    <div class="meta-item year">
                        <span>üìÖ</span>
                        <span id="movieYear">2002</span>
                    </div>
                    <div class="meta-item duration">
                        <span>‚è±Ô∏è</span>
                        <span id="movieDuration">2h 11ph√∫t</span>
                    </div>
                    <div class="meta-item genre">
                        <span>üé≠</span>
                        <span id="movieGenre">H√†nh ƒë·ªông</span>
                    </div>
                    <div class="meta-item age-rating">
                        <span>üîû</span>
                        <span>R - 17+</span>
                    </div>
                </div>

                <!-- Like/Dislike Actions -->
                <div class="rating-actions">
                    <button class="rating-btn" id="likeBtn" onclick="toggleLike()">
                        <span>üëç</span>
                        <span>Th√≠ch</span>
                        <span class="count" id="likeCount">0</span>
                    </button>
                    <button class="rating-btn" id="dislikeBtn" onclick="toggleDislike()">
                        <span>üëé</span>
                        <span>Kh√¥ng th√≠ch</span>
                        <span class="count" id="dislikeCount">0</span>
                    </button>
                </div>

                <!-- Movie Actions -->
                <div class="movie-actions">
                    <button class="action-btn primary" onclick="restartMovie()">
                        <span>üîÑ</span>
                        <span>Xem l·∫°i t·ª´ ƒë·∫ßu</span>
                    </button>
                    <button class="action-btn" onclick="toggleFavorite()">
                        <span>‚ù§Ô∏è</span>
                        <span id="favoriteText">Th√™m v√†o y√™u th√≠ch</span>
                    </button>
                    <button class="action-btn" onclick="downloadMovie()">
                        <span>‚¨áÔ∏è</span>
                        <span>T·∫£i xu·ªëng</span>
                    </button>
                    <button class="action-btn" onclick="shareMovie()">
                        <span>üì§</span>
                        <span>Chia s·∫ª</span>
                    </button>
                    <button class="action-btn" onclick="toggleComments()">
                        <span>üí¨</span>
                        <span>B√¨nh lu·∫≠n</span>
                    </button>
                </div>
                <div id="episode-list">
    <h2>Danh s√°ch t·∫≠p</h2>
    <div id="episodes-container"></div>
</div>

<script>
// L·∫•y id phim t·ª´ URL
function getMovieIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
}
const movieId = getMovieIdFromUrl();

// Global variable ƒë·ªÉ l∆∞u danh s√°ch episodes
let currentEpisodes = [];

// L·∫•y th√¥ng tin phim v√† c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ ƒë·ªông
if (movieId) {
    fetch(`http://localhost:8080/api/cartoons/${movieId}`)
        .then(res => res.json())
        .then(movie => {
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ trang
            document.title = movie.title + ' | Maxion';
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ hi·ªÉn th·ªã
            const h1 = document.querySelector('.movie-details h1');
            if (h1) h1.textContent = movie.title;
            
            // C·∫≠p nh·∫≠t th√¥ng tin meta phim
            updateMovieInfo(movie);
            
            // C·∫≠p nh·∫≠t m√¥ t·∫£ phim
            const description = document.querySelector('.movie-details .description');
            if (description && movie.description) {
                description.textContent = movie.description;
            }
            
            // C·∫≠p nh·∫≠t nƒÉm ph√°t h√†nh
            const yearElement = document.querySelector('.meta-item:nth-child(2) span:nth-child(2)');
            if (yearElement && movie.releaseYear) {
                yearElement.textContent = movie.releaseYear;
            }
            
            // C·∫≠p nh·∫≠t th·ªÉ lo·∫°i
            const genreElement = document.querySelector('.meta-item:nth-child(4) span:nth-child(2)');
            if (genreElement && movie.genre) {
                genreElement.textContent = movie.genre;
            }
        })
        .catch(err => {
            console.error("L·ªói khi t·∫£i th√¥ng tin phim:", err);
        });
}

if (!movieId) {
    document.getElementById('episodes-container').innerText = "Kh√¥ng t√¨m th·∫•y id phim!";
} else {
    fetch(`http://localhost:8080/api/cartoons/${movieId}/episodes`)
        .then(res => {
            console.log('Episodes API status:', res.status);
            console.log('Episodes API content-type:', res.headers.get('content-type'));
            if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y t·∫≠p phim!");
            
            // Ki·ªÉm tra content-type tr∆∞·ªõc khi parse JSON
            const contentType = res.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('API kh√¥ng tr·∫£ v·ªÅ JSON, c√≥ th·ªÉ l√† trang l·ªói HTML');
            }
            
            return res.json();
        })        .then(episodes => {
            console.log('[DEBUG] Episodes received:', episodes);
            const container = document.getElementById('episodes-container');
            console.log('[DEBUG] Container found:', container);
            
            if (episodes.length === 0) {
                // N·∫øu ch∆∞a c√≥ t·∫≠p n√†o, hi·ªÉn th·ªã th√¥ng b√°o
                container.innerHTML = '<p>Phim n√†y ch∆∞a c√≥ t·∫≠p n√†o ƒë·ªÉ xem.</p>';
            } else {
                // S·∫Øp x·∫øp t·∫≠p theo th·ª© t·ª±
                episodes.sort((a, b) => a.episode_number - b.episode_number);
                console.log('[DEBUG] Episodes sorted:', episodes);
                
                // L∆∞u v√†o bi·∫øn global
                currentEpisodes = episodes;
                console.log('[DEBUG] currentEpisodes saved:', currentEpisodes);
                
                // T·ª± ƒë·ªông ph√°t t·∫≠p ƒë·∫ßu ti√™n
                const firstEpisode = episodes[0];
                if (firstEpisode && firstEpisode.video_url) {
                    console.log('ƒêang load t·∫≠p ƒë·∫ßu ti√™n:', firstEpisode);
                    loadEpisode(firstEpisode);
                }                
                
                // Hi·ªÉn th·ªã danh s√°ch t·∫≠p theo h√†ng ngang v·ªõi onclick ƒë∆°n gi·∫£n h∆°n
                const episodesHtml = episodes.map((ep, index) => `
                    <div class="episode-number-btn ${ep.id === firstEpisode.id ? 'active' : ''}" 
                         onclick="loadEpisodeByIndex(${index})"
                         data-episode-id="${ep.id}"
                         data-episode-number="${ep.episode_number}"
                         title="${ep.title}">
                        ${ep.episode_number}
                    </div>
                `).join('');
                
                console.log('[DEBUG] Episodes HTML:', episodesHtml);
                
                const finalHtml = `
                    <div class="episodes-horizontal">
                        ${episodesHtml}
                    </div>
                `;
                console.log('[DEBUG] Final HTML:', finalHtml);
                
                container.innerHTML = finalHtml;
                console.log('[DEBUG] Container updated');
            }
        })
        .catch(err => {
            console.error("L·ªói khi t·∫£i danh s√°ch t·∫≠p:", err);
            document.getElementById('episodes-container').innerText = "Kh√¥ng th·ªÉ t·∫£i danh s√°ch t·∫≠p.";
        });
}

// H√†m load episode b·∫±ng index t·ª´ currentEpisodes array
function loadEpisodeByIndex(index) {
    if (currentEpisodes && currentEpisodes[index]) {
        const episode = currentEpisodes[index];
        console.log('Loading episode by index:', index, episode);
        loadEpisode(episode);
    } else {
        console.error('Kh√¥ng t√¨m th·∫•y episode v·ªõi index:', index);
    }
}

// H√†m load v√† ph√°t m·ªôt t·∫≠p phim
function loadEpisode(episode) {
    console.log('Loading episode:', episode);
    console.log('Episode number:', episode.episode_number);
    console.log('Video URL:', episode.video_url);
    
    // Update active episode first
    updateActiveEpisode(episode.episode_number);
    
    // N·∫øu l√† YouTube URL, chuy·ªÉn ƒë·ªïi sang embed format
    let videoUrl = episode.video_url;
    if (videoUrl.includes('youtu.be/') || videoUrl.includes('youtube.com/watch')) {
        // Chuy·ªÉn YouTube URL sang embed format
        let videoId = '';
        if (videoUrl.includes('youtu.be/')) {
            videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
        } else if (videoUrl.includes('youtube.com/watch?v=')) {
            videoId = videoUrl.split('v=')[1].split('&')[0];
        }
        
        if (videoId) {
            console.log('Loading YouTube video:', videoId);
            // T·∫°o iframe cho YouTube thay v√¨ d√πng video element
            const videoContainer = document.querySelector('.video-player');
            videoContainer.innerHTML = `
                <iframe width="100%" height="100%" 
                        src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
            `;
            
            // Update episode title
            updateEpisodeTitle(episode);
            return;
        }
    }
    
    // ƒê·ªëi v·ªõi video th√¥ng th∆∞·ªùng (MP4, etc.), restore video element if needed
    let video = document.getElementById('videoElement');
    if (!video) {
        console.log('Restoring video element...');
        const videoContainer = document.querySelector('.video-player');
        videoContainer.innerHTML = `
            <video class="video-element" id="videoElement" preload="metadata">
                <source src="" type="video/mp4">
                <track kind="captions" src="" srclang="vi" label="Ti·∫øng Vi·ªát">
                <track kind="captions" src="" srclang="en" label="English">
                Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª video.
            </video>
            <!-- Add back other video player UI elements if needed -->
        `;
        video = document.getElementById('videoElement');
    }    
    // ƒê·ªëi v·ªõi video th√¥ng th∆∞·ªùng (MP4, etc.)
    video.src = videoUrl;
    video.load();
    
    // T·ª± ƒë·ªông ph√°t
    video.play().catch(err => {
        console.log('Autoplay b·ªã ch·∫∑n:', err);
    });
    
    // Update episode title
    updateEpisodeTitle(episode);
}

// Helper function to update episode title
function updateEpisodeTitle(episode) {
    const currentEpisodeTitle = document.querySelector('.current-episode-title');
    if (currentEpisodeTitle) {
        currentEpisodeTitle.textContent = `T·∫≠p ${episode.episode_number}: ${episode.title}`;
    }
}
</script>

                <div class="cast-crew">
                    <h3>Di·ªÖn vi√™n & ƒê·∫°o di·ªÖn</h3>
                    <div class="cast-list">
                        <div class="cast-member">
                            <div class="cast-avatar">KR</div>
                            <div class="cast-name">Keanu Reeves</div>
                        </div>
                        <div class="cast-member">
                            <div class="cast-avatar">HB</div>
                            <div class="cast-name">Halle Berry</div>
                        </div>
                        <div class="cast-member">
                            <div class="cast-avatar">IM</div>
                            <div class="cast-name">Ian McShane</div>
                        </div>
                        <div class="cast-member">
                            <div class="cast-avatar">LF</div>
                            <div class="cast-name">Laurence Fishburne</div>
                        </div>
                        <div class="cast-member">
                            <div class="cast-avatar">CS</div>
                            <div class="cast-name">Chad Stahelski</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar">                <h3>Phim li√™n quan</h3>
                <div class="related-movies">
                    <div class="related-movie" onclick="playRelatedMovie(2)">
                        <div class="related-poster">NA</div>
                        <div class="related-info">
                            <h4>Naruto</h4>
                            <p>2002 ‚Ä¢ Anime</p>
                            <div class="related-rating">
                                <span>‚≠ê</span>
                                <span>8.5</span>
                            </div>
                        </div>
                    </div>

                    <div class="related-movie" onclick="playRelatedMovie(6)">
                        <div class="related-poster">JK</div>
                        <div class="related-info">
                            <h4>Jujutsu Kaisen</h4>
                            <p>2020 ‚Ä¢ Anime</p>
                            <div class="related-rating">
                                <span>‚≠ê</span>
                                <span>9.0</span>
                            </div>
                        </div>
                    </div>

                    <div class="related-movie" onclick="playRelatedMovie(5)">
                        <div class="related-poster">AOT</div>                        <div class="related-info">
                            <h4>Attack on Titan</h4>
                            <p>2013 ‚Ä¢ Anime</p>
                            <div class="related-rating">
                                <span>‚≠ê</span>
                                <span>9.2</span>
                            </div>
                        </div>
                    </div>

                    <div class="related-movie" onclick="playRelatedMovie(7)">
                        <div class="related-poster">DS</div>
                        <div class="related-info">
                            <h4>Demon Slayer</h4>
                            <p>2019 ‚Ä¢ Anime</p>
                            <div class="related-rating">
                                <span>‚≠ê</span>
                                <span>8.8</span>
                            </div>
                        </div>
                    </div>

                    <div class="related-movie" onclick="playRelatedMovie(9)">
                        <div class="related-poster">MHA</div>
                        <div class="related-info">
                            <h4>My Hero Academia</h4>
                            <p>2016 ‚Ä¢ Anime</p>
                            <div class="related-rating">
                                <span>‚≠ê</span>
                                <span>8.6</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="comments-section">
            <div class="comments-header">
                <h3>B√¨nh lu·∫≠n (847)</h3>
                <select style="background: var(--secondary-bg); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.2); padding: 8px; border-radius: 6px;">
                    <option>M·ªõi nh·∫•t</option>
                    <option>C≈© nh·∫•t</option>
                    <option>Ph·ªï bi·∫øn nh·∫•t</option>
                </select>
            </div>

            <div class="comment-form">
                <textarea class="comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..."></textarea>
                <div class="comment-actions">
                    <button class="action-button btn-primary" onclick="postComment()">ƒêƒÉng b√¨nh lu·∫≠n</button>
                </div>
            </div>

            <div class="comments-list">
                <div class="comment">
                    <div class="comment-avatar">AN</div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">Anh Nguy·ªÖn</span>
                            <span class="comment-time">2 gi·ªù tr∆∞·ªõc</span>
                        </div>
                        <div class="comment-text">
                            Phim hay tuy·ªát v·ªùi! John Wick 3 th·ª±c s·ª± kh√¥ng l√†m t√¥i th·∫•t v·ªçng. Nh·ªØng pha h√†nh ƒë·ªông m√£n nh√£n v√† k·ªãch b·∫£n ch·∫∑t ch·∫Ω. Keanu Reeves th·∫≠t s·ª± ƒë√£ th·ªÉ hi·ªán xu·∫•t s·∫Øc vai di·ªÖn n√†y.
                        </div>
                        <div class="comment-actions-list">
                            <button class="comment-action">
                                <span>üëç</span>
                                <span>124</span>
                            </button>
                            <button class="comment-action">
                                <span>üëé</span>
                                <span>5</span>
                            </button>
                            <button class="comment-action">Tr·∫£ l·ªùi</button>
                        </div>
                    </div>
                </div>

                <div class="comment">
                    <div class="comment-avatar">MT</div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">Minh Tr·∫ßn</span>
                            <span class="comment-time">5 gi·ªù tr∆∞·ªõc</span>
                        </div>
                        <div class="comment-text">
                            T√¥i ƒë√£ xem c·∫£ series John Wick v√† ph·∫ßn n√†y th·ª±c s·ª± l√† ƒë·ªânh cao. Nh·ªØng pha ƒë√°nh ƒë·∫•m ƒë∆∞·ª£c choreograph c·ª±c k·ª≥ tinh t·∫ø v√† chuy√™n nghi·ªáp.
                        </div>
                        <div class="comment-actions-list">
                            <button class="comment-action">
                                <span>üëç</span>
                                <span>89</span>
                            </button>
                            <button class="comment-action">
                                <span>üëé</span>
                                <span>2</span>
                            </button>
                            <button class="comment-action">Tr·∫£ l·ªùi</button>
                        </div>
                    </div>
                </div>

                <div class="comment">
                    <div class="comment-avatar">HL</div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">H∆∞∆°ng Ly</span>
                            <span class="comment-time">1 ng√†y tr∆∞·ªõc</span>
                        </div>
                        <div class="comment-text">
                            Ch·∫•t l∆∞·ª£ng 4K tr√™n Maxion th·∫≠t s·ª± tuy·ªát v·ªùi! H√¨nh ·∫£nh r·∫•t s·∫Øc n√©t v√† √¢m thanh s·ªëng ƒë·ªông. X·ª©ng ƒë√°ng v·ªõi t·ª´ng ƒë·ªìng ƒë√£ tr·∫£.
                        </div>
                        <div class="comment-actions-list">
                            <button class="comment-action">
                                <span>üëç</span>
                                <span>67</span>
                            </button>
                            <button class="comment-action">
                                <span>üëé</span>
                                <span>1</span>
                            </button>
                            <button class="comment-action">Tr·∫£ l·ªùi</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // DOM Elements
        const video = document.getElementById('videoElement');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const progressContainer = document.getElementById('progressContainer');
        const progressFilled = document.getElementById('progressFilled');
        const progressThumb = document.getElementById('progressThumb');
        const timeDisplay = document.getElementById('timeDisplay');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeFilled = document.getElementById('volumeFilled');
        const volumeIcon = document.getElementById('volumeIcon');
        const muteBtn = document.getElementById('muteBtn');
        const fullscreenIcon = document.getElementById('fullscreenIcon');
        const speedIcon = document.getElementById('speedIcon');
        const videoControls = document.getElementById('videoControls');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoContainer = document.getElementById('videoContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const qualitySelector = document.getElementById('qualitySelector');
        const header = document.getElementById('header');
        const theaterIcon = document.getElementById('theaterIcon');
        const contentSection = document.getElementById('contentSection');
        const pipContainer = document.getElementById('pipContainer');
        const pipVideo = document.getElementById('pipVideo');
        const notification = document.getElementById('notification');

        // Video State
        let isPlaying = false;
        let isMuted = false;
        let currentVolume = 0.7;
        let currentSpeed = 1;
        let isTheaterMode = false;
        let isPiPActive = false;
        let controlsTimeout;
        let isFullscreen = false;
        let subtitlesEnabled = false;

        // Playback speeds
        const playbackSpeeds = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2];
        let currentSpeedIndex = 3; // 1x

        // Initialize video player
        document.addEventListener('DOMContentLoaded', function() {
            initializePlayer();
            setupEventListeners();
            
            // Show loading
            showLoading();
            
            // Hide loading when video is ready
            video.addEventListener('canplay', hideLoading);
            video.addEventListener('loadedmetadata', updateDuration);
        });

        function initializePlayer() {
            video.volume = currentVolume;
            updateVolumeDisplay();
            updateSpeedDisplay();
            
            // Set initial state
            video.currentTime = 0;
            updateProgress();
        }

        function setupEventListeners() {
            // Video events
            video.addEventListener('loadstart', showLoading);
            video.addEventListener('canplay', hideLoading);
            video.addEventListener('waiting', showLoading);
            video.addEventListener('playing', hideLoading);
            video.addEventListener('timeupdate', updateProgress);
            video.addEventListener('ended', onVideoEnded);
            video.addEventListener('play', () => {
                isPlaying = true;
                playIcon.textContent = '‚è∏';
            });
            video.addEventListener('pause', () => {
                isPlaying = false;
                playIcon.textContent = '‚ñ∂';
            });

            // Progress bar
            progressContainer.addEventListener('click', seek);
            progressContainer.addEventListener('mousemove', showProgressPreview);

            // Volume control
            volumeSlider.addEventListener('click', setVolume);

            // Controls visibility
            videoPlayer.addEventListener('mouseenter', showControls);
            videoPlayer.addEventListener('mouseleave', hideControlsDelayed);
            videoPlayer.addEventListener('mousemove', showControls);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboard);

            // Click to play/pause
            video.addEventListener('click', togglePlayPause);

            // Auto-hide header when playing
            video.addEventListener('play', () => {
                if (isPlaying) {
                    setTimeout(() => {
                        if (isPlaying && !videoPlayer.matches(':hover')) {
                            header.classList.add('hidden');
                        }
                    }, 3000);
                }
            });

            video.addEventListener('pause', () => {
                header.classList.remove('hidden');
            });

            // Fullscreen change
            document.addEventListener('fullscreenchange', updateFullscreenIcon);
        }

        // Playback controls
        function togglePlayPause() {
            if (video.paused) {
                video.play();
                showNotification('ƒêang ph√°t video', 'success');
            } else {
                video.pause();
                showNotification('ƒê√£ t·∫°m d·ª´ng', 'success');
            }
        }

        function seek(e) {
            const rect = progressContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const newTime = (clickX / rect.width) * video.duration;
            video.currentTime = newTime;
        }

        function updateProgress() {
            if (video.duration) {
                const progress = (video.currentTime / video.duration) * 100;
                progressFilled.style.width = `${progress}%`;
                progressThumb.style.left = `${progress}%`;
                
                // Update time display
                const current = formatTime(video.currentTime);
                const duration = formatTime(video.duration);
                timeDisplay.textContent = `${current} / ${duration}`;
            }
        }

        function updateDuration() {
            const duration = formatTime(video.duration);
            timeDisplay.textContent = `00:00 / ${duration}`;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // Volume controls
        function toggleMute() {
            if (isMuted) {
                video.volume = currentVolume;
                isMuted = false;
                volumeIcon.textContent = 'üîä';
            } else {
                currentVolume = video.volume;
                video.volume = 0;
                isMuted = true;
                volumeIcon.textContent = 'üîá';
            }
            updateVolumeDisplay();
        }

        function setVolume(e) {
            const rect = volumeSlider.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const newVolume = Math.max(0, Math.min(1, clickX / rect.width));
            
            video.volume = newVolume;
            currentVolume = newVolume;
            isMuted = false;
            
            updateVolumeDisplay();
            updateVolumeIcon();
        }

        function updateVolumeDisplay() {
            const volumePercent = isMuted ? 0 : (video.volume * 100);
            volumeFilled.style.width = `${volumePercent}%`;
        }

        function updateVolumeIcon() {
            if (isMuted || video.volume === 0) {
                volumeIcon.textContent = 'üîá';
            } else if (video.volume < 0.5) {
                volumeIcon.textContent = 'üîâ';
            } else {
                volumeIcon.textContent = 'üîä';
            }
        }

        // Playback speed
        function changePlaybackSpeed() {
            currentSpeedIndex = (currentSpeedIndex + 1) % playbackSpeeds.length;
            currentSpeed = playbackSpeeds[currentSpeedIndex];
            video.playbackRate = currentSpeed;
            updateSpeedDisplay();
            showNotification(`T·ªëc ƒë·ªô ph√°t: ${currentSpeed}x`, 'success');
        }

        function updateSpeedDisplay() {
            speedIcon.textContent = `${currentSpeed}x`;
        }

        // Fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    console.log('Error entering fullscreen:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function updateFullscreenIcon() {
            isFullscreen = !!document.fullscreenElement;
            fullscreenIcon.textContent = isFullscreen ? '‚õ∂' : '‚õ∂';
        }

        // Theater mode
        function toggleTheaterMode() {
            isTheaterMode = !isTheaterMode;
            document.body.classList.toggle('theater-mode', isTheaterMode);
            theaterIcon.textContent = isTheaterMode ? '‚õ∂' : '‚õ∂';
            
            if (isTheaterMode) {
                showNotification('ƒê√£ b·∫≠t ch·∫ø ƒë·ªô r·∫°p', 'success');
            } else {
                showNotification('ƒê√£ t·∫Øt ch·∫ø ƒë·ªô r·∫°p', 'success');
            }
        }

        // Picture in Picture
        function togglePictureInPicture() {
            if (!isPiPActive) {
                if (document.pictureInPictureEnabled) {
                    video.requestPictureInPicture()
                        .then(() => {
                            isPiPActive = true;
                            showNotification('ƒê√£ b·∫≠t Picture in Picture', 'success');
                        })
                        .catch(err => {
                            console.log('PiP error:', err);
                            showNotification('Kh√¥ng th·ªÉ b·∫≠t Picture in Picture', 'error');
                        });
                } else {
                    // Fallback PiP implementation
                    enableCustomPiP();
                }
            } else {
                if (document.pictureInPictureElement) {
                    document.exitPictureInPicture();
                } else {
                    disableCustomPiP();
                }
            }
        }

        function enableCustomPiP() {
            pipContainer.classList.add('active');
            pipVideo.src = video.src;
            pipVideo.currentTime = video.currentTime;
            if (isPlaying) {
                pipVideo.play();
            }
            isPiPActive = true;
            showNotification('ƒê√£ b·∫≠t Picture in Picture', 'success');
        }

        function disableCustomPiP() {
            pipContainer.classList.remove('active');
            isPiPActive = false;
            showNotification('ƒê√£ t·∫Øt Picture in Picture', 'success');
        }

        function closePiP() {
            disableCustomPiP();
        }

        // Quality selector
        function toggleQuality() {
            qualitySelector.classList.toggle('active');
        }

        function changeQuality(quality) {
            const currentTime = video.currentTime;
            const wasPlaying = !video.paused;
            
            // Update active quality option
            document.querySelectorAll('.quality-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // In a real app, you would change the video source here
            showNotification(`ƒê√£ chuy·ªÉn sang ch·∫•t l∆∞·ª£ng ${quality}`, 'success');
            qualitySelector.classList.remove('active');
            
            // Restore playback state
            video.currentTime = currentTime;
            if (wasPlaying) {
                video.play();
            }
        }

        // Subtitles
        function toggleSubtitles() {
            subtitlesEnabled = !subtitlesEnabled;
            
            if (subtitlesEnabled) {
                // Enable subtitles
                if (video.textTracks.length > 0) {
                    video.textTracks[0].mode = 'showing';
                }
                showNotification('ƒê√£ b·∫≠t ph·ª• ƒë·ªÅ', 'success');
            } else {
                // Disable subtitles
                Array.from(video.textTracks).forEach(track => {
                    track.mode = 'hidden';
                });
                showNotification('ƒê√£ t·∫Øt ph·ª• ƒë·ªÅ', 'success');
            }
        }

        // Controls visibility
        function showControls() {
            videoControls.classList.add('visible');
            clearTimeout(controlsTimeout);
            
            controlsTimeout = setTimeout(() => {
                if (isPlaying && !videoPlayer.matches(':hover')) {
                    hideControls();
                }
            }, 3000);
        }

        function hideControls() {
            videoControls.classList.remove('visible');
        }

        function hideControlsDelayed() {
            clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(hideControls, 1000);
        }

        // Loading
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Video ended
        function onVideoEnded() {
            showNotification('Video ƒë√£ k·∫øt th√∫c', 'success');
            // Auto-play next episode or related video
            setTimeout(() => {
                showNotification('ƒêang t·ª± ƒë·ªông ph√°t video ti·∫øp theo...', 'success');
            }, 3000);
        }

        // Keyboard shortcuts
        function handleKeyboard(e) {
            // Prevent default browser shortcuts when video is focused
            if (document.activeElement === video || e.target.closest('.video-player')) {
                switch(e.code) {
                    case 'Space':
                        e.preventDefault();
                        togglePlayPause();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        video.currentTime -= 10;
                        showNotification('Tua l√πi 10 gi√¢y', 'success');
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        video.currentTime += 10;
                        showNotification('Tua t·ªõi 10 gi√¢y', 'success');
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        video.volume = Math.min(1, video.volume + 0.1);
                        updateVolumeDisplay();
                        updateVolumeIcon();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        video.volume = Math.max(0, video.volume - 0.1);
                        updateVolumeDisplay();
                        updateVolumeIcon();
                        break;
                    case 'KeyM':
                        e.preventDefault();
                        toggleMute();
                        break;
                    case 'KeyF':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'KeyT':
                        e.preventDefault();
                        toggleTheaterMode();
                        break;
                    case 'KeyC':
                        e.preventDefault();
                        toggleSubtitles();
                        break;
                }
            }
        }

        // Navigation functions
        function goBack() {
            // In a real app, this would navigate back to the previous page
            showNotification('ƒêang quay l·∫°i trang tr∆∞·ªõc...', 'success');
            setTimeout(() => {
                window.history.back();
            }, 1000);
        }

        // Movie actions
        function restartMovie() {
            video.currentTime = 0;
            video.play();
            showNotification('ƒêang ph√°t l·∫°i t·ª´ ƒë·∫ßu', 'success');
        }

        function addToWatchlist() {
            showNotification('ƒê√£ th√™m v√†o danh s√°ch y√™u th√≠ch', 'success');
        }

        function downloadMovie() {
            showNotification('B·∫Øt ƒë·∫ßu t·∫£i xu·ªëng...', 'success');
        }

        function shareMovie() {
            if (navigator.share) {
                navigator.share({
                    title: 'John Wick: Chapter 3 - Parabellum',
                    text: 'Xem phim hay tr√™n Maxion',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showNotification('ƒê√£ sao ch√©p li√™n k·∫øt', 'success');
            }
        }

        function playRelatedMovie(movieId) {
            // Chuy·ªÉn h∆∞·ªõng sang trang phim m·ªõi v·ªõi id
            window.location.href = `moive.html?id=${movieId}`;
        }

        // Comments
        function postComment() {
            const commentInput = document.querySelector('.comment-input');
            const comment = commentInput.value.trim();
            
            if (comment) {
                showNotification('ƒê√£ ƒëƒÉng b√¨nh lu·∫≠n', 'success');
                commentInput.value = '';
            } else {
                showNotification('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n', 'error');
            }
        }

        // Notification system
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Progress preview (hover)
        function showProgressPreview(e) {
            // In a real app, this would show thumbnail preview
            const rect = progressContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const previewTime = (clickX / rect.width) * video.duration;
            
            // You could show a tooltip with the time here
        }

        // Auto-hide header on scroll
        let lastScrollY = 0;
        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;
            
            if (currentScrollY > lastScrollY && currentScrollY > 100) {
                header.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
            }
            
            lastScrollY = currentScrollY;
        });

        // Click outside to close quality selector
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.quality-selector') && !e.target.closest('[onclick*="toggleQuality"]')) {
                qualitySelector.classList.remove('active');
            }
        });        // Initialize focus for keyboard controls
        videoPlayer.setAttribute('tabindex', '0');
        videoPlayer.focus();

        // ===== NEW FUNCTIONS =====
        
        // Like/Dislike functionality
        let isLiked = false;
        let isDisliked = false;
        let likeCount = 0;
        let dislikeCount = 0;

        function toggleLike() {
            const likeBtn = document.getElementById('likeBtn');
            const dislikeBtn = document.getElementById('dislikeBtn');
            const likeCountEl = document.getElementById('likeCount');
            
            if (isLiked) {
                // Unlike
                isLiked = false;
                likeCount = Math.max(0, likeCount - 1);
                likeBtn.classList.remove('liked');
            } else {
                // Like
                isLiked = true;
                likeCount += 1;
                likeBtn.classList.add('liked');
                
                // Remove dislike if exists
                if (isDisliked) {
                    isDisliked = false;
                    dislikeCount = Math.max(0, dislikeCount - 1);
                    dislikeBtn.classList.remove('disliked');
                    document.getElementById('dislikeCount').textContent = dislikeCount;
                }
            }
            
            likeCountEl.textContent = likeCount;
            showNotification(isLiked ? 'ƒê√£ th√≠ch!' : 'ƒê√£ b·ªè th√≠ch!', 'success');
        }

        function toggleDislike() {
            const likeBtn = document.getElementById('likeBtn');
            const dislikeBtn = document.getElementById('dislikeBtn');
            const dislikeCountEl = document.getElementById('dislikeCount');
            
            if (isDisliked) {
                // Remove dislike
                isDisliked = false;
                dislikeCount = Math.max(0, dislikeCount - 1);
                dislikeBtn.classList.remove('disliked');
            } else {
                // Dislike
                isDisliked = true;
                dislikeCount += 1;
                dislikeBtn.classList.add('disliked');
                
                // Remove like if exists
                if (isLiked) {
                    isLiked = false;
                    likeCount = Math.max(0, likeCount - 1);
                    likeBtn.classList.remove('liked');
                    document.getElementById('likeCount').textContent = likeCount;
                }
            }
            
            dislikeCountEl.textContent = dislikeCount;
            showNotification(isDisliked ? 'ƒê√£ kh√¥ng th√≠ch!' : 'ƒê√£ b·ªè kh√¥ng th√≠ch!', 'success');
        }

        // Restart movie
        function restartMovie() {
            const video = document.getElementById('videoElement');
            if (video) {
                video.currentTime = 0;
                video.play();
                showNotification('ƒêang ph√°t l·∫°i t·ª´ ƒë·∫ßu', 'success');
            }
        }

        // Favorite functionality
        let isFavorite = false;
        function toggleFavorite() {
            const favoriteText = document.getElementById('favoriteText');
            isFavorite = !isFavorite;
            
            if (isFavorite) {
                favoriteText.textContent = 'ƒê√£ th√™m v√†o y√™u th√≠ch';
                showNotification('ƒê√£ th√™m v√†o danh s√°ch y√™u th√≠ch!', 'success');
            } else {
                favoriteText.textContent = 'Th√™m v√†o y√™u th√≠ch';
                showNotification('ƒê√£ x√≥a kh·ªèi danh s√°ch y√™u th√≠ch!', 'warning');
            }
        }

        // Download movie
        function downloadMovie() {
            showNotification('T√≠nh nƒÉng t·∫£i xu·ªëng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
        }

        // Share movie
        function shareMovie() {
            if (navigator.share && navigator.share.url) {
                navigator.share({
                    title: document.title,
                    text: 'Xem phim tuy·ªát v·ªùi n√†y!',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showNotification('ƒê√£ sao ch√©p li√™n k·∫øt chia s·∫ª!', 'success');
            }
        }

        // Comments toggle
        let commentsVisible = false;
        function toggleComments() {
            commentsVisible = !commentsVisible;
            if (commentsVisible) {
                showNotification('T√≠nh nƒÉng b√¨nh lu·∫≠n ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
            }
        }        // Update movie meta information from API
        function updateMovieInfo(movie) {
            document.getElementById('movieYear').textContent = movie.releaseYear || '2002';
            document.getElementById('movieGenre').textContent = movie.genre || 'H√†nh ƒë·ªông';
            
            // T·∫°m th·ªùi s·ª≠ d·ª•ng rating tƒ©nh do API rating c√≥ v·∫•n ƒë·ªÅ
            const defaultRating = '7.4';
            document.getElementById('movieRating').textContent = defaultRating;
            
            // TODO: Load rating from API when fixed
            // loadMovieRating(movie.id);
            
            // Update description if available
            const descEl = document.querySelector('.description');
            if (movie.description && descEl) {
                descEl.textContent = movie.description;
            }
        }

        // Load rating from API
        function loadMovieRating(movieId) {
            // Fallback rating n·∫øu kh√¥ng c√≥ ID ho·∫∑c API th·∫•t b·∫°i
            const fallbackRating = '7.4';
            const fallbackReviews = '0';
            
            if (!movieId) {
                document.getElementById('movieRating').textContent = fallbackRating;
                return;
            }
            
            // G·ªçi API ƒë·ªÉ l·∫•y rating th·ª±c
            fetch(`http://localhost:8080/api/cartoons/${movieId}/rating`)
                .then(res => {
                    if (!res.ok) throw new Error('API rating failed');
                    return res.json();
                })
                .then(data => {
                    if (data && data.averageRating !== undefined) {
                        const rating = data.averageRating > 0 ? data.averageRating.toFixed(1) : fallbackRating;
                        const totalReviews = data.totalReviews || 0;
                        
                        document.getElementById('movieRating').textContent = rating;
                        
                        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng reviews n·∫øu c√≥ element
                        const reviewCountEl = document.getElementById('reviewCount');
                        if (reviewCountEl) {
                            reviewCountEl.textContent = `(${totalReviews} ƒë√°nh gi√°)`;
                        }
                        
                        console.log(`[RATING] Loaded rating: ${rating}/10 from ${totalReviews} reviews`);
                    } else {
                        document.getElementById('movieRating').textContent = fallbackRating;
                    }
                })
                .catch(err => {
                    console.warn('[RATING] Failed to load rating from API, using fallback:', err);
                    document.getElementById('movieRating').textContent = fallbackRating;                });
        }
        
        // Update active episode button
        function updateActiveEpisode(episodeNumber) {
            // Remove active class from all episode buttons
            document.querySelectorAll('.episode-number-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to current episode by data attribute
            document.querySelectorAll('.episode-number-btn').forEach(btn => {
                const btnEpisodeNumber = btn.getAttribute('data-episode-number');
                if (btnEpisodeNumber && parseInt(btnEpisodeNumber) === episodeNumber) {                    btn.classList.add('active');
                }
            });
        }
        
    </script>
</body>
</html>