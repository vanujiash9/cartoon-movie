<!DOCTYPE html>
<html lang="vi">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì s∆° c·ªßa t√¥i - Maxion</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    
    <link rel="stylesheet" href="user.css">
    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--background-primary, #1a1a1a);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            padding: 20px 25px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color, #333);
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--text-primary, #fff);
            font-size: 1.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-secondary, #ccc);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background-color: var(--border-color, #333);
            color: var(--text-primary, #fff);
        }
        
        .modal-body {
            padding: 0 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            border-top: 1px solid var(--border-color, #333);
            margin-top: 20px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .password-requirements {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--background-secondary, #2a2a2a);
            border-radius: 8px;
        }
        
        .password-requirements p {
            margin: 0 0 10px;
            color: var(--text-secondary, #ccc);
            font-size: 0.9rem;
        }
        
        .password-requirements ul {
            margin: 0;
            padding-left: 20px;
            color: var(--text-secondary, #ccc);
            font-size: 0.85rem;
        }
        
        .password-requirements li {
            margin: 5px 0;
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .modal-header, .modal-body, .modal-footer {
                padding-left: 20px;
                padding-right: 20px;
            }
            
            .form-actions, .modal-footer {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Header -->
    <nav class="navbar">
        <a href="#" class="navbar-brand">
            <img src="https://i.postimg.cc/KvjKVZXj/logo.png" alt="Maxion Logo">
        </a>

        <ul class="navbar-nav">
            <li><a href="../index.html" class="navbar-link">Trang ch·ªß</a></li>
            <li><a href="./user.html" class="navbar-link active">H·ªì s∆°</a></li>
        </ul>        <div class="navbar-actions">
            <!-- X√ìA N√öT CHUY·ªÇN ƒê·ªîI S√ÅNG/T·ªêI -->
            <!-- <button class="theme-toggle" id="themeToggle">
                <ion-icon name="sunny" id="themeIcon"></ion-icon>
            </button> -->
            
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHRleHQgeD0iMjAiIHk9IjI2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+VTwvdGV4dD4KPHN2Zz4=" alt="User Avatar" class="user-avatar">
        </div>
    </nav>

    <div class="container">
        <main class="main-content">
            <!-- Profile Header -->
            <section class="profile-header">                <div class="profile-content">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiMzNDk4ZGIiLz4KPHRleHQgeD0iNDAiIHk9IjUyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+VTwvdGV4dD4KPHN2Zz4=" alt="Profile Avatar" class="profile-avatar" id="profileAvatar">
                    
                    <div class="profile-info">
                        <h1 id="userName">Ch∆∞a ƒëƒÉng nh·∫≠p</h1>
                        <p class="subtitle">Th√†nh vi√™n Premium ‚Ä¢ ƒê√£ tham gia t·ª´ th√°ng 3/2024</p>
                        
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="moviesWatched">47</span>
                                <span class="stat-label">Phim ƒë√£ xem</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="hoursWatched">124</span>
                                <span class="stat-label">Gi·ªù ƒë√£ xem</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="favoriteMovies">23</span>
                                <span class="stat-label">Y√™u th√≠ch</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="achievementsUnlocked">8</span>
                                <span class="stat-label">Th√†nh t·ª±u</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-actions">
                        <button class="btn btn-primary" onclick="editProfile()">
                            <ion-icon name="create-outline"></ion-icon>
                            Ch·ªânh s·ª≠a h·ªì s∆°
                        </button>
                        <button class="btn btn-secondary" onclick="shareProfile()">
                            <ion-icon name="share-outline"></ion-icon>
                            Chia s·∫ª h·ªì s∆°
                        </button>
                    </div>
                </div>
            </section>

            <!-- Main Grid -->
            <div class="profile-grid">
                <!-- Favorite Movies -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="heart" class="card-icon"></ion-icon>
                            Phim y√™u th√≠ch
                        </h3>
                        <span class="card-action" onclick="viewAllFavorites()">Xem t·∫•t c·∫£ ‚Üí</span>
                    </div>
                    
                    <div class="movie-list" id="favoriteMoviesList">
                        <!-- Movies will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Watch History -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="time" class="card-icon"></ion-icon>
                            L·ªãch s·ª≠ xem g·∫ßn ƒë√¢y
                        </h3>
                        <span class="card-action" onclick="viewAllHistory()">Xem t·∫•t c·∫£ ‚Üí</span>
                    </div>
                    
                    <div class="movie-list" id="watchHistoryList">
                        <!-- Movies will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Achievements -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="trophy" class="card-icon"></ion-icon>
                            Th√†nh t·ª±u
                        </h3>
                        <span class="card-action" onclick="viewAllAchievements()">Xem t·∫•t c·∫£ ‚Üí</span>
                    </div>
                    
                    <div class="achievements-grid" id="achievementsList">
                        <!-- Achievements will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Settings -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="settings" class="card-icon"></ion-icon>
                            C√†i ƒë·∫∑t t√†i kho·∫£n
                        </h3>
                    </div>
                    
                    <div class="settings-form">                        <div class="form-group">
                            <label class="form-label">T√™n hi·ªÉn th·ªã</label>
                            <input type="text" id="displayName" class="form-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="userEmail" class="form-input" placeholder="Email c·ªßa b·∫°n">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="userPhone" class="form-input" placeholder="S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-switch">
                                <div class="switch active" onclick="toggleSwitch(this)"></div>
                                <span>Nh·∫≠n th√¥ng b√°o phim m·ªõi</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-switch">
                                <div class="switch" onclick="toggleSwitch(this)"></div>
                                <span>T·ª± ƒë·ªông ph√°t t·∫≠p ti·∫øp theo</span>
                            </label>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="saveSettings()">
                                <ion-icon name="save-outline"></ion-icon>
                                L∆∞u thay ƒë·ªïi
                            </button>
                            <button class="btn btn-secondary" onclick="showChangePasswordModal()">
                                <ion-icon name="lock-closed-outline"></ion-icon>
                                ƒê·ªïi m·∫≠t kh·∫©u
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card card-full">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="pulse" class="card-icon"></ion-icon>
                            Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
                        </h3>
                        <span class="card-action" onclick="clearActivity()">X√≥a l·ªãch s·ª≠ ‚Üí</span>
                    </div>
                    
                    <div class="activity-timeline" id="activityTimeline">
                        <!-- Activity will be populated by JavaScript -->
                    </div>
                </div>
            </div>        </main>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ch·ªânh s·ª≠a h·ªì s∆°</h2>
                <button class="modal-close" onclick="closeEditProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="form-group">
                        <label class="form-label">T√™n hi·ªÉn th·ªã</label>
                        <input type="text" id="editDisplayName" class="form-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="editUserEmail" class="form-input" placeholder="Email c·ªßa b·∫°n">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="editUserPhone" class="form-input" placeholder="S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Gi·ªõi thi·ªáu b·∫£n th√¢n</label>
                        <textarea id="editUserBio" class="form-input" rows="3" placeholder="Vi·∫øt v√†i d√≤ng v·ªÅ b·∫£n th√¢n..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditProfileModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveProfileChanges()">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ƒê·ªïi m·∫≠t kh·∫©u</h2>
                <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                        <input type="password" id="currentPassword" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
                        <input type="password" id="newPassword" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
                    </div>
                    
                    <div class="password-requirements">
                        <p>M·∫≠t kh·∫©u ph·∫£i c√≥:</p>
                        <ul>
                            <li>√çt nh·∫•t 8 k√Ω t·ª±</li>
                            <li>√çt nh·∫•t 1 ch·ªØ hoa</li>
                            <li>√çt nh·∫•t 1 ch·ªØ s·ªë</li>
                            <li>√çt nh·∫•t 1 k√Ω t·ª± ƒë·∫∑c bi·ªát</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeChangePasswordModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="savePasswordChanges()">ƒê·ªïi m·∫≠t kh·∫©u</button>
            </div>
        </div>
    </div>
    
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="../js/shared-api.js"></script>
      <script>
        'use strict';

        // User data from localStorage
        let currentUser = null;
        
        // Dynamic data holders
        let userAchievements = [];
        let userFavorites = [];
        let userHistory = [];
        let userStats = { moviesWatched: 0, hoursWatched: 0, favoriteMovies: 0, achievementsUnlocked: 0 };        // DOM elements
        const notification = document.getElementById('notification');

        // === API HELPER FUNCTIONS ===
        
        // Get authentication headers
        function getAuthHeaders() {
            const authToken = localStorage.getItem('authToken');
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (currentUser) {
                headers['X-User-ID'] = currentUser.id.toString();
                headers['X-Username'] = currentUser.username;
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
            }
            
            return headers;        }

        // === HELPER FUNCTIONS ===
        
        // Create movie poster SVG
        function createMoviePoster(title) {
            return `data:image/svg+xml;base64,${btoa(`<svg width="200" height="300" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="300" fill="#34495e"/><text x="100" y="150" text-anchor="middle" fill="white" font-size="14">${title}</text></svg>`)}`;
        }
        
        // Create fallback movie data
        function createFallbackMovie(movieId, title = null) {
            const movieTitle = title || `Phim ${movieId}`;
            return {
                id: movieId,
                title: movieTitle,
                genre: 'Phim ho·∫°t h√¨nh',
                year: '2024',
                rating: '8.0',
                poster: createMoviePoster(movieTitle)
            };
        }
        
        // === DATA LOADING FUNCTIONS ===        // Load user achievements from API
        async function loadUserAchievements() {
            if (!currentUser) {
                userAchievements = [];
                userStats.achievementsUnlocked = 0;
                return;
            }
            
            try {
                // Get user achievements
                const result = await apiCall(`/api/user-achievements/user/${currentUser.id}`);
                
                if (result.success) {
                    const achievements = result.data || [];
                    
                    // Convert to our format
                    userAchievements = achievements.map(userAchievement => {
                        const achievement = userAchievement.achievement || {};
                        return {
                            id: achievement.id,
                            name: achievement.name || achievement.title || 'Th√†nh t·ª±u',
                            description: achievement.description || 'M√¥ t·∫£ th√†nh t·ª±u',
                            icon: getAchievementIcon(achievement.name || achievement.title || 'Th√†nh t·ª±u'),
                            progress: 100, // If user has it, it's 100%
                            unlocked: true,
                            unlockedAt: userAchievement.unlockedAt || null
                        };
                    });
                    
                    // Update stats
                    userStats.achievementsUnlocked = achievements.length;
                } else {
                    console.warn('Failed to load achievements:', result.error);
                    // Fallback to sample achievements if API fails
                    createSampleAchievements();
                }
                
            } catch (error) {
                console.error('Error loading achievements:', error);
                // Fallback to sample achievements if API fails
                createSampleAchievements();
            }
        }
        
        // Create sample achievements for fallback
        function createSampleAchievements() {
            userAchievements = [
                {
                    id: 1,
                    name: 'B∆∞·ªõc ƒë·∫ßu ti√™n',
                    description: 'Xem b·ªô phim ƒë·∫ßu ti√™n',
                    icon: 'üé¨',
                    progress: 100,
                    unlocked: true,
                    unlockedAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 7).toISOString()
                },
                {
                    id: 2,
                    name: 'Ng∆∞·ªùi y√™u phim',
                    description: 'Xem 10 b·ªô phim',
                    icon: '‚ù§Ô∏è',
                    progress: 100,
                    unlocked: true,
                    unlockedAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 3).toISOString()
                },
                {
                    id: 3,
                    name: 'Nh√† s∆∞u t·∫≠p',
                    description: 'Th√™m 25 phim v√†o y√™u th√≠ch',
                    icon: 'üìö',
                    progress: 80,
                    unlocked: false,
                    unlockedAt: null
                }
            ];
            
            // Only count unlocked achievements
            userStats.achievementsUnlocked = userAchievements.filter(a => a.unlocked).length;
            console.log('Using sample achievements due to API unavailability');
        }

        // Helper function to get achievement icons
        function getAchievementIcon(name) {
            const iconMap = {
                'B∆∞·ªõc ƒë·∫ßu ti√™n': 'üé¨',
                'Ng∆∞·ªùi y√™u phim': '‚ù§Ô∏è',
                'Th·ª©c ƒë√™m xem phim': 'üåô',
                'Nh√† ph√™ b√¨nh': '‚≠ê',
                'Nh√† s∆∞u t·∫≠p': 'üìö',
                'Nh√† th√°m hi·ªÉm': 'üó∫Ô∏è',
                'Kh·ªüi ƒë·∫ßu': 'üöÄ',
                'Xem phim': 'üì∫',
                'ƒê√°nh gi√°': 'üåü',
                'B√¨nh lu·∫≠n': 'üí¨'
            };
            
            for (const [key, icon] of Object.entries(iconMap)) {
                if (name.toLowerCase().includes(key.toLowerCase())) {
                    return icon;
                }
            }
            
            return 'üèÜ'; // Default icon
        }        // Load user favorite movies (from localStorage click history)
        async function loadUserFavorites() {
            try {
                // Get click history from localStorage
                const clickHistory = JSON.parse(localStorage.getItem('movieClickHistory') || '[]');
                
                if (clickHistory.length === 0) {
                    userFavorites = [];
                    userStats.favoriteMovies = 0;
                    return;
                }
                
                // Get top clicked movies
                const movieCounts = {};
                clickHistory.forEach(click => {
                    movieCounts[click.movieId] = (movieCounts[click.movieId] || 0) + 1;
                });
                
                // Sort by click count and get top 6
                const topMovieIds = Object.entries(movieCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 6)
                    .map(([movieId]) => parseInt(movieId));
                  // Fetch movie details for top clicked movies
                userFavorites = [];
                for (const movieId of topMovieIds) {
                    try {
                        const result = await apiCall(`/api/cartoons/${movieId}`);
                        if (result.success) {
                            const movie = result.data;
                            userFavorites.push({
                                id: movie.id,
                                title: movie.title || movie.name,
                                genre: movie.genre || 'Phim ho·∫°t h√¨nh',
                                year: movie.year || new Date(movie.releaseDate || Date.now()).getFullYear().toString(),
                                rating: movie.rating || '8.0',
                                poster: movie.posterUrl || movie.imageUrl || `data:image/svg+xml;base64,${btoa(`<svg width="200" height="300" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="300" fill="#34495e"/><text x="100" y="150" text-anchor="middle" fill="white" font-size="14">${movie.title || movie.name}</text></svg>`)}`
                            });
                        } else {
                            throw new Error(result.error || 'Failed to load movie');
                        }
                    } catch (error) {
                        console.warn(`Could not load movie ${movieId}, using fallback:`, error);
                        // Add fallback movie data
                        userFavorites.push(createFallbackMovie(movieId));
                    }
                }
                
                userStats.favoriteMovies = userFavorites.length;
                
            } catch (error) {
                console.error('Error loading favorites:', error);
                userFavorites = [];
                userStats.favoriteMovies = 0;
            }
        }        // Load user watch history
        async function loadUserHistory() {
            try {
                // Get recent history from localStorage
                const watchHistory = JSON.parse(localStorage.getItem('watchHistory') || '[]');
                
                if (watchHistory.length === 0) {
                    userHistory = [];
                    userStats.moviesWatched = 0;
                    userStats.hoursWatched = 0;
                    return;
                }
                
                // Get recent 6 movies
                const recentMovies = watchHistory
                    .sort((a, b) => new Date(b.watchedAt) - new Date(a.watchedAt))
                    .slice(0, 6);
                  userHistory = [];
                for (const historyItem of recentMovies) {
                    try {
                        const result = await apiCall(`/api/cartoons/${historyItem.movieId}`);
                        if (result.success) {
                            const movie = result.data;
                            userHistory.push({
                                id: movie.id,
                                title: movie.title || movie.name,
                                genre: movie.genre || 'Phim ho·∫°t h√¨nh',
                                year: movie.year || new Date(movie.releaseDate || Date.now()).getFullYear().toString(),
                                rating: movie.rating || '8.0',
                                poster: movie.posterUrl || movie.imageUrl || `data:image/svg+xml;base64,${btoa(`<svg width="200" height="300" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="300" fill="#34495e"/><text x="100" y="150" text-anchor="middle" fill="white" font-size="14">${movie.title || movie.name}</text></svg>`)}`,
                                watchedAt: formatTimeAgo(new Date(historyItem.watchedAt))
                            });
                        } else {
                            throw new Error(result.error || 'Failed to load movie');
                        }
                    } catch (error) {
                        console.warn(`Could not load movie ${historyItem.movieId}, using fallback:`, error);
                        // Add fallback movie data
                        userHistory.push(createFallbackMovie(historyItem.movieId, historyItem.title));
                    }
                }
                
                userStats.moviesWatched = watchHistory.length;
                userStats.hoursWatched = Math.floor(watchHistory.length * 1.5); // Estimate 1.5 hours per movie
                  } catch (error) {
                console.error('Error loading history:', error);
                userHistory = [];
                userStats.moviesWatched = 0;
                userStats.hoursWatched = 0;
            }
        }

        // Helper function to format time ago
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMinutes < 60) {
                return `${diffMinutes} ph√∫t tr∆∞·ªõc`;
            } else if (diffHours < 24) {
                return `${diffHours} gi·ªù tr∆∞·ªõc`;
            } else {
                return `${diffDays} ng√†y tr∆∞·ªõc`;
            }
        }

        // === UPDATE PROFILE API ===
          // Update user profile
        async function updateUserProfile(profileData) {
            try {
                showNotification('ƒêang c·∫≠p nh·∫≠t h·ªì s∆°...', 'info');
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Since there's no dedicated profile update API, we'll update localStorage
                // and potentially create a new API endpoint later
                
                const updatedUser = { ...currentUser, ...profileData };
                localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                
                // Update individual fields in localStorage
                if (profileData.fullName) {
                    localStorage.setItem('fullName', profileData.fullName);
                    localStorage.setItem('username', profileData.fullName);
                }
                if (profileData.email) {
                    localStorage.setItem('email', profileData.email);
                }
                if (profileData.phone) {
                    localStorage.setItem('phone', profileData.phone);
                }
                
                currentUser = updatedUser;
                showNotification('ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!', 'success');
                
                // Update display immediately
                document.getElementById('userName').textContent = profileData.fullName || currentUser.username;
                document.querySelector('#displayName').value = profileData.fullName || '';
                document.querySelector('#userEmail').value = profileData.email || '';
                document.querySelector('#userPhone').value = profileData.phone || '';
                
                return true;
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('L·ªói c·∫≠p nh·∫≠t h·ªì s∆°: ' + error.message, 'error');
                return false;
            }
        }

        // Change password
        async function changePassword(currentPassword, newPassword) {
            try {
                // For now, we'll simulate password change
                // In production, this should call a real API
                showNotification('ƒêang thay ƒë·ªïi m·∫≠t kh·∫©u...', 'info');
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // TODO: Implement actual password change API
                // const result = await apiCall('/api/auth/change-password', 'POST', {
                //     currentPassword,
                //     newPassword
                // });
                
                showNotification('ƒê√£ thay ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!', 'success');
                return true;
            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('L·ªói thay ƒë·ªïi m·∫≠t kh·∫©u: ' + error.message, 'error');
                return false;
            }
        }        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });        // Load user data from localStorage and update UI
        window.addEventListener('DOMContentLoaded', function() {
            // Get user info from localStorage
            currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            
            if (!currentUser) {
                showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem h·ªì s∆°', 'error');
                console.log('No user found, redirecting to login...');
                // Redirect to login page after 2 seconds
                setTimeout(() => {
                    // Check if login page exists, otherwise stay on current page
                    if (document.querySelector('a[href*="login"]')) {
                        window.location.href = '../login-register/login.html';
                    } else {
                        console.log('Login page not found, staying on current page');
                        // Create a demo user for testing
                        console.log('Creating demo user for testing...');
                        simulateLogin('demouser', 'Demo User');
                    }
                }, 2000);
                return;
            }
            
            console.log('Current user:', currentUser);
            // Load all user data
            loadUserData();
        });

        async function initializePage() {
            // Initialize theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Add fade-in animation to cards
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                card.classList.add('fade-in');
            });
        }        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                showNotification('ƒêang t·∫£i d·ªØ li·ªáu h·ªì s∆°...', 'info');
                console.log('Loading user data for:', currentUser);
                
                // Load user display info
                const username = currentUser.username || 'Ch∆∞a ƒëƒÉng nh·∫≠p';
                const fullName = currentUser.fullName || currentUser.username || '';
                const email = currentUser.email || '';
                
                console.log('User info:', { username, fullName, email });
                
                // Update user display
                document.getElementById('userName').textContent = fullName || username;
                  // Update avatar
                const profileAvatar = document.getElementById('profileAvatar');
                const navbarAvatar = document.querySelector('.user-avatar');
                if (profileAvatar && username) {
                    const firstLetter = (fullName || username).charAt(0).toUpperCase();
                    const avatarSvg = `data:image/svg+xml;base64,${btoa(`
                        <svg width='80' height='80' viewBox='0 0 80 80' fill='none' xmlns='http://www.w3.org/2000/svg'>
                            <circle cx='40' cy='40' r='40' fill='#3498db'/>
                            <text x='40' y='52' text-anchor='middle' font-family='Arial' font-size='36' font-weight='bold' fill='white'>${firstLetter}</text>
                        </svg>
                    `)}`;
                    profileAvatar.src = avatarSvg;
                    
                    // Also update navbar avatar
                    if (navbarAvatar) {
                        const navbarAvatarSvg = `data:image/svg+xml;base64,${btoa(`
                            <svg width='40' height='40' viewBox='0 0 40 40' fill='none' xmlns='http://www.w3.org/2000/svg'>
                                <circle cx='20' cy='20' r='20' fill='#3498db'/>
                                <text x='20' y='26' text-anchor='middle' font-family='Arial' font-size='18' font-weight='bold' fill='white'>${firstLetter}</text>
                            </svg>
                        `)}`;
                        navbarAvatar.src = navbarAvatarSvg;
                    }
                }
                  // Update form fields
                const inputName = document.querySelector('#displayName');
                const inputEmail = document.querySelector('#userEmail');
                const inputPhone = document.querySelector('#userPhone');
                if (inputName) inputName.value = fullName;
                if (inputEmail) inputEmail.value = email;
                if (inputPhone) inputPhone.value = currentUser.phone || '';
                  // Load dynamic data from APIs and localStorage
                console.log('Starting to load dynamic data...');
                await Promise.all([
                    loadUserAchievements().then(() => console.log('Achievements loaded:', userAchievements.length)),
                    loadUserFavorites().then(() => console.log('Favorites loaded:', userFavorites.length)),
                    loadUserHistory().then(() => console.log('History loaded:', userHistory.length))
                ]);
                
                console.log('All data loaded successfully');
                
                // Update UI with loaded data
                updateUserStats();
                populateFavoriteMovies();
                populateWatchHistory();
                populateAchievements();
                populateRecentActivity();
                
                showNotification('ƒê√£ t·∫£i d·ªØ li·ªáu h·ªì s∆° th√†nh c√¥ng!', 'success');
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
            }
        }

        function updateUserStats() {
            // Update user stats in the UI
            document.getElementById('moviesWatched').textContent = userStats.moviesWatched;
            document.getElementById('hoursWatched').textContent = userStats.hoursWatched;
            document.getElementById('favoriteMovies').textContent = userStats.favoriteMovies;
            document.getElementById('achievementsUnlocked').textContent = userStats.achievementsUnlocked;
        }        function populateFavoriteMovies() {
            const container = document.getElementById('favoriteMoviesList');
            
            if (userFavorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <ion-icon name="heart-outline"></ion-icon>
                        <h3>Ch∆∞a c√≥ phim y√™u th√≠ch</h3>
                        <p>H√£y th√™m nh·ªØng b·ªô phim b·∫°n y√™u th√≠ch v√†o danh s√°ch</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = userFavorites.map(movie => `
                <div class="movie-item">
                    <img src="${movie.poster}" alt="${movie.title}" class="movie-poster">
                    <div class="movie-info">
                        <h4>${movie.title}</h4>
                        <div class="movie-meta">
                            <span>${movie.genre}</span>
                            <span>${movie.year}</span>
                            <div class="movie-rating">
                                <ion-icon name="star"></ion-icon>
                                ${movie.rating}
                            </div>
                        </div>
                    </div>
                    <div class="movie-actions">
                        <button class="action-btn" onclick="playMovie('${movie.title}')" title="Ph√°t">
                            <ion-icon name="play"></ion-icon>
                        </button>
                        <button class="action-btn" onclick="removeFromFavorites('${movie.title}')" title="X√≥a kh·ªèi y√™u th√≠ch">
                            <ion-icon name="heart-dislike"></ion-icon>
                        </button>
                    </div>
                </div>
            `).join('');
        }        function populateWatchHistory() {
            const container = document.getElementById('watchHistoryList');
            
            if (userHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <ion-icon name="time-outline"></ion-icon>
                        <h3>Ch∆∞a c√≥ l·ªãch s·ª≠ xem</h3>
                        <p>L·ªãch s·ª≠ xem phim c·ªßa b·∫°n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = userHistory.map(movie => `
                <div class="movie-item">
                    <img src="${movie.poster}" alt="${movie.title}" class="movie-poster">
                    <div class="movie-info">
                        <h4>${movie.title}</h4>
                        <div class="movie-meta">
                            <span>${movie.genre}</span>
                            <span>${movie.year}</span>
                            <div class="movie-rating">
                                <ion-icon name="star"></ion-icon>
                                ${movie.rating}
                            </div>
                            <span style="color: var(--light-azure)">${movie.watchedAt}</span>
                        </div>
                    </div>
                    <div class="movie-actions">
                        <button class="action-btn" onclick="playMovie('${movie.title}')" title="Xem l·∫°i">
                            <ion-icon name="refresh"></ion-icon>
                        </button>
                        <button class="action-btn" onclick="addToFavorites('${movie.title}')" title="Th√™m v√†o y√™u th√≠ch">
                            <ion-icon name="heart-outline"></ion-icon>
                        </button>
                    </div>
                </div>
            `).join('');
        }        function populateAchievements() {
            const container = document.getElementById('achievementsList');
            
            if (userAchievements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <ion-icon name="trophy-outline"></ion-icon>
                        <h3>Ch∆∞a c√≥ th√†nh t·ª±u</h3>
                        <p>H√£y xem phim ƒë·ªÉ m·ªü kh√≥a th√†nh t·ª±u m·ªõi</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = userAchievements.map(achievement => `
                <div class="achievement-item ${achievement.unlocked ? 'unlocked' : ''}">
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                    <div class="achievement-progress">
                        <div class="progress-fill" style="width: ${achievement.progress}%"></div>
                    </div>
                    <span style="font-size: 12px; color: var(--light-azure);">
                        ${achievement.progress}%
                    </span>
                </div>
            `).join('');
        }        function populateRecentActivity() {
            const container = document.getElementById('activityTimeline');
            
            // Create recent activity from user data
            const activities = [];
            
            // Add recent movie watches
            userHistory.slice(0, 3).forEach(movie => {
                activities.push({
                    icon: 'play-circle',
                    title: `Xem phim "${movie.title}"`,
                    description: `ƒê√£ xem b·ªô phim ${movie.genre}`,
                    time: movie.watchedAt
                });
            });
            
            // Add recent achievements
            userAchievements.filter(a => a.unlocked).slice(0, 2).forEach(achievement => {
                activities.push({
                    icon: 'trophy',
                    title: `M·ªü kh√≥a th√†nh t·ª±u "${achievement.name}"`,
                    description: achievement.description,
                    time: achievement.unlockedAt ? formatTimeAgo(new Date(achievement.unlockedAt)) : 'G·∫ßn ƒë√¢y'
                });
            });
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <ion-icon name="pulse-outline"></ion-icon>
                        <h3>Ch∆∞a c√≥ ho·∫°t ƒë·ªông</h3>
                        <p>Ho·∫°t ƒë·ªông c·ªßa b·∫°n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activities.map(activity => `
                <div class="timeline-item">
                    <div class="timeline-icon">
                        <ion-icon name="${activity.icon}"></ion-icon>
                    </div>
                    <div class="timeline-content">
                        <h4>${activity.title}</h4>
                        <p>${activity.description}</p>
                        <span class="timeline-time">${activity.time}</span>
                    </div>
                </div>
            `).join('');
        }

        // Settings functions
        function toggleSwitch(element) {
            element.classList.toggle('active');
            const isActive = element.classList.contains('active');
            const label = element.nextElementSibling.textContent;
            
            showNotification(`${isActive ? 'B·∫≠t' : 'T·∫Øt'} ${label.toLowerCase()}`, 'success');
        }        function saveSettings() {
            const name = document.querySelector('#displayName').value;
            const email = document.querySelector('#userEmail').value;
            const phone = document.querySelector('#userPhone').value;
            
            if (!name.trim()) {
                showNotification('Vui l√≤ng nh·∫≠p t√™n hi·ªÉn th·ªã', 'error');
                return;
            }
            
            if (!email.trim()) {
                showNotification('Vui l√≤ng nh·∫≠p email', 'error');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Email kh√¥ng h·ª£p l·ªá', 'error');
                return;
            }
            
            // Update user profile
            updateUserProfile({
                fullName: name,
                email: email,
                phone: phone
            });
        }        // Profile actions
        function editProfile() {
            showEditProfileModal();
        }
        
        // Modal functions
        function showEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            const editDisplayName = document.getElementById('editDisplayName');
            const editUserEmail = document.getElementById('editUserEmail');
            const editUserPhone = document.getElementById('editUserPhone');
            const editUserBio = document.getElementById('editUserBio');
            
            // Pre-fill form with current data
            if (currentUser) {
                editDisplayName.value = currentUser.fullName || currentUser.username || '';
                editUserEmail.value = currentUser.email || '';
                editUserPhone.value = currentUser.phone || '';
                editUserBio.value = currentUser.bio || '';
            }
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function saveProfileChanges() {
            const editDisplayName = document.getElementById('editDisplayName');
            const editUserEmail = document.getElementById('editUserEmail');
            const editUserPhone = document.getElementById('editUserPhone');
            const editUserBio = document.getElementById('editUserBio');
            
            const name = editDisplayName.value.trim();
            const email = editUserEmail.value.trim();
            const phone = editUserPhone.value.trim();
            const bio = editUserBio.value.trim();
            
            if (!name) {
                showNotification('Vui l√≤ng nh·∫≠p t√™n hi·ªÉn th·ªã', 'error');
                return;
            }
            
            if (!email) {
                showNotification('Vui l√≤ng nh·∫≠p email', 'error');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Email kh√¥ng h·ª£p l·ªá', 'error');
                return;
            }
            
            // Update user profile
            updateUserProfile({
                fullName: name,
                email: email,
                phone: phone,
                bio: bio
            }).then(success => {
                if (success) {
                    closeEditProfileModal();
                    loadUserData(); // Reload user data to reflect changes
                }
            });
        }
        
        function showChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function savePasswordChanges() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword) {
                showNotification('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i', 'error');
                return;
            }
            
            if (!newPassword) {
                showNotification('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
                return;
            }
            
            // Validate password strength
            if (!validatePassword(newPassword)) {
                showNotification('M·∫≠t kh·∫©u kh√¥ng ƒë·ªß m·∫°nh', 'error');
                return;
            }
            
            // Change password
            changePassword(currentPassword, newPassword).then(success => {
                if (success) {
                    closeChangePasswordModal();
                }
            });
        }
        
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);
              return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar;
        }
        
        // === DEBUG AND TEST FUNCTIONS ===
        
        // Function to simulate login for testing
        function simulateLogin(username = 'testuser', fullName = 'Nguy·ªÖn VƒÉn Test') {
            const testUser = {
                id: 1,
                username: username,
                fullName: fullName,
                email: username + '@example.com',
                phone: '0901234567',
                bio: 'T√¥i l√† ng∆∞·ªùi d√πng test',
                isPremium: true,
                joinDate: '2024-03-01'
            };
            
            localStorage.setItem('currentUser', JSON.stringify(testUser));
            localStorage.setItem('username', username);
            localStorage.setItem('fullName', fullName);
            localStorage.setItem('email', testUser.email);
            
            // Create some sample data
            createSampleData();
            
            location.reload();
        }
          // Create sample data for testing
        function createSampleData() {
            // Sample movie click history - using realistic cartoon IDs
            const sampleClickHistory = [
                { movieId: 1, title: 'One Piece', clickedAt: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString() },
                { movieId: 2, title: 'Naruto', clickedAt: new Date(Date.now() - 1000 * 60 * 60 * 5).toISOString() },
                { movieId: 3, title: 'Dragon Ball', clickedAt: new Date(Date.now() - 1000 * 60 * 60 * 10).toISOString() },
                { movieId: 1, title: 'One Piece', clickedAt: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString() },
                { movieId: 4, title: 'Attack on Titan', clickedAt: new Date(Date.now() - 1000 * 60 * 60 * 48).toISOString() },
                { movieId: 2, title: 'Naruto', clickedAt: new Date(Date.now() - 1000 * 60 * 60 * 72).toISOString() },
                { movieId: 5, title: 'My Hero Academia', clickedAt: new Date(Date.now() - 1000 * 60 * 60 * 96).toISOString() },
                { movieId: 1, title: 'One Piece', clickedAt: new Date(Date.now() - 1000 * 60 * 60 * 120).toISOString() }
            ];
            
            // Sample watch history
            const sampleWatchHistory = [
                { movieId: 1, title: 'One Piece', watchedAt: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString() },
                { movieId: 2, title: 'Naruto', watchedAt: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString() },
                { movieId: 3, title: 'Dragon Ball', watchedAt: new Date(Date.now() - 1000 * 60 * 60 * 48).toISOString() },
                { movieId: 4, title: 'Attack on Titan', watchedAt: new Date(Date.now() - 1000 * 60 * 60 * 72).toISOString() },
                { movieId: 5, title: 'My Hero Academia', watchedAt: new Date(Date.now() - 1000 * 60 * 60 * 96).toISOString() },
                { movieId: 6, title: 'Demon Slayer', watchedAt: new Date(Date.now() - 1000 * 60 * 60 * 168).toISOString() }
            ];
            
            localStorage.setItem('movieClickHistory', JSON.stringify(sampleClickHistory));
            localStorage.setItem('watchHistory', JSON.stringify(sampleWatchHistory));
            
            console.log('Sample data created with movie IDs:', sampleClickHistory.map(c => c.movieId));
            console.log('Watch history created:', sampleWatchHistory.length, 'items');
        }
        
        // Clear all user data
        function clearUserData() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('username');
            localStorage.removeItem('fullName');
            localStorage.removeItem('email');
            localStorage.removeItem('phone');
            localStorage.removeItem('movieClickHistory');
            localStorage.removeItem('watchHistory');
            console.log('User data cleared!');
        }
          // Console commands for testing
        console.log(`
=== DEBUG COMMANDS ===
ƒê·ªÉ test c√°c ch·ª©c nƒÉng, b·∫°n c√≥ th·ªÉ d√πng:
- simulateLogin('username', 'Full Name') - M√¥ ph·ªèng ƒëƒÉng nh·∫≠p
- createSampleData() - T·∫°o d·ªØ li·ªáu m·∫´u
- clearUserData() - X√≥a t·∫•t c·∫£ d·ªØ li·ªáu user
- showEditProfileModal() - M·ªü modal ch·ªânh s·ª≠a h·ªì s∆°
- showChangePasswordModal() - M·ªü modal ƒë·ªïi m·∫≠t kh·∫©u

V√≠ d·ª•: simulateLogin('nguyenvana', 'Nguy·ªÖn VƒÉn A')

=== CURRENT STATUS ===
User: ${currentUser ? currentUser.username : 'Not logged in'}
Click History: ${JSON.parse(localStorage.getItem('movieClickHistory') || '[]').length} items
Watch History: ${JSON.parse(localStorage.getItem('watchHistory') || '[]').length} items
        `);

        function shareProfile() {
            if (navigator.share) {
                const shareData = {
                    title: 'H·ªì s∆° Maxion c·ªßa t√¥i',
                    text: `Xem h·ªì s∆° phim c·ªßa ${currentUser?.fullName || currentUser?.username || 't√¥i'} tr√™n Maxion`,
                    url: window.location.href
                };
                navigator.share(shareData);
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href);
                showNotification('ƒê√£ sao ch√©p li√™n k·∫øt h·ªì s∆°!', 'success');
            }
        }// Movie actions
        function playMovie(title) {
            // Add to watch history
            const movieId = Math.floor(Math.random() * 100) + 1; // Random ID for demo
            addToWatchHistory(movieId, title);
            showNotification(`ƒêang ph√°t: ${title}`, 'success');
        }

        function addToFavorites(title) {
            const movieId = Math.floor(Math.random() * 100) + 1; // Random ID for demo
            addToClickHistory(movieId, title);
            showNotification(`ƒê√£ th√™m "${title}" v√†o y√™u th√≠ch`, 'success');
        }

        function removeFromFavorites(title) {
            // Remove from click history
            const clickHistory = JSON.parse(localStorage.getItem('movieClickHistory') || '[]');
            const updatedHistory = clickHistory.filter(item => item.title !== title);
            localStorage.setItem('movieClickHistory', JSON.stringify(updatedHistory));
            
            showNotification(`ƒê√£ x√≥a "${title}" kh·ªèi y√™u th√≠ch`, 'success');
            
            // Reload favorites
            loadUserFavorites().then(() => {
                populateFavoriteMovies();
                updateUserStats();
            });
        }
        
        // Helper functions for managing history
        function addToClickHistory(movieId, title) {
            const clickHistory = JSON.parse(localStorage.getItem('movieClickHistory') || '[]');
            clickHistory.push({
                movieId: movieId,
                title: title,
                clickedAt: new Date().toISOString()
            });
            localStorage.setItem('movieClickHistory', JSON.stringify(clickHistory));
        }
        
        function addToWatchHistory(movieId, title) {
            const watchHistory = JSON.parse(localStorage.getItem('watchHistory') || '[]');
            watchHistory.push({
                movieId: movieId,
                title: title,
                watchedAt: new Date().toISOString()
            });
            localStorage.setItem('watchHistory', JSON.stringify(watchHistory));
        }

        // View functions
        function viewAllFavorites() {
            showNotification('ƒêang chuy·ªÉn ƒë·∫øn trang phim y√™u th√≠ch...', 'success');
        }

        function viewAllHistory() {
            showNotification('ƒêang chuy·ªÉn ƒë·∫øn l·ªãch s·ª≠ xem ƒë·∫ßy ƒë·ªß...', 'success');
        }

        function viewAllAchievements() {
            showNotification('ƒêang chuy·ªÉn ƒë·∫øn trang th√†nh t·ª±u...', 'success');
        }

        function clearActivity() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ ho·∫°t ƒë·ªông?')) {
                document.getElementById('activityTimeline').innerHTML = `
                    <div class="empty-state">
                        <ion-icon name="checkmark-circle-outline"></ion-icon>
                        <h3>ƒê√£ x√≥a l·ªãch s·ª≠</h3>
                        <p>Ho·∫°t ƒë·ªông m·ªõi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                    </div>
                `;
                showNotification('ƒê√£ x√≥a l·ªãch s·ª≠ ho·∫°t ƒë·ªông', 'success');
            }
        }

        // Notification system
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Auto-update stats simulation
        setInterval(() => {
            const statsElements = document.querySelectorAll('.stat-number');
            statsElements.forEach(el => {
                if (Math.random() < 0.1) { // 10% chance to update
                    const currentValue = parseInt(el.textContent);
                    el.textContent = currentValue + 1;
                    el.style.color = 'var(--success)';
                    setTimeout(() => {
                        el.style.color = 'var(--light-azure)';
                    }, 1000);
                }
            });
        }, 10000); // Every 10 seconds        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                editProfile();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveSettings();
            }
            
            // Close modals with Escape key
            if (e.key === 'Escape') {
                closeEditProfileModal();
                closeChangePasswordModal();
            }
        });
        
        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            const editModal = document.getElementById('editProfileModal');
            const passwordModal = document.getElementById('changePasswordModal');
            
            if (e.target === editModal) {
                closeEditProfileModal();
            }
            
            if (e.target === passwordModal) {
                closeChangePasswordModal();
            }
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Add click handlers for interactive elements
            document.addEventListener('click', function(e) {
                if (e.target.closest('.movie-item')) {
                    const movieTitle = e.target.closest('.movie-item').querySelector('h4').textContent;
                    showNotification(`ƒêang ph√°t: ${movieTitle}`, 'success');
                }
            });
        }
    </script>
</body>
</html>