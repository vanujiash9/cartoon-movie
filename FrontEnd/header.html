<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Header - Maxion</title>
   
    <link rel="stylesheet" href="header.css">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <header>
        <div class="navbar" id="navbar">
            <a href="#" class="navbar-brand" onclick="navigateToHome()">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMTQwIDQwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8dGV4dCB4PSIyMCIgeT0iMjgiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiMzNDk4ZGIiPk1heGlvbjwvdGV4dD4KPC9zdmc+" alt="Maxion Logo">
            </a>

            <nav id="navMenu">
                <ul class="navbar-nav">
                    <li><a href="#" class="navbar-link" onclick="smartNavigate('top')">Trang ch·ªß</a></li>
                    <li><a href="#" class="navbar-link" onclick="smartNavigate('movies')">Danh s√°ch phim</a></li>
                    <li><a href="#" class="navbar-link indicator" onclick="smartNavigate('achievements')">Th√†nh t·ª±u</a></li>
                    <li><a href="#" class="navbar-link" onclick="smartNavigate('category')">Th·ªÉ lo·∫°i</a></li>
                    <li><a href="#" class="navbar-link" onclick="smartNavigate('live')">TV Tr·ª±c ti·∫øp</a></li>
                </ul>
            </nav>

            <div class="navbar-actions">
                <form class="navbar-form" id="searchForm">
                    <input type="text" name="search" placeholder="T√¨m ki·∫øm phim..." class="navbar-form-search" id="searchInput">

                    <button type="button" class="navbar-form-btn" id="searchBtn">
                        <span style="font-size: 18px;">üîç</span>
                    </button>

                    <div class="search-suggestions" id="searchSuggestions"></div>
                </form>                <button class="voice-btn" id="voiceBtn" title="T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i">
                    <span>üé§</span>
                </button>

                <!-- Notification Bell -->
                <div class="notification-bell" id="notificationBell" title="Th√¥ng b√°o">
                    <button class="notification-btn" id="notificationBtn">
                        <span class="bell-icon">üîî</span>
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </button>
                    
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h4>Th√¥ng b√°o</h4>
                            <button class="mark-all-read" id="markAllRead">ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-item loading">
                                <span>ƒêang t·∫£i...</span>
                            </div>
                        </div>
                        <div class="notification-footer">
                            <a href="#" onclick="viewAllNotifications()">Xem t·∫•t c·∫£ th√¥ng b√°o</a>
                        </div>
                    </div>
                </div><a href="./login_register/login.html" target="_top" class="navbar-signin" id="signInBtn">
                    <span id="signInText">ƒêƒÉng nh·∫≠p</span>
                    <span style="margin-left: 8px;">‚û°Ô∏è</span>
                </a>

                <!-- User menu (hidden by default) -->
                <div class="user-menu" id="userMenu">
                    <div class="user-info-display" id="userInfoDisplay">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+Cjx0ZXh0IHg9IjEwIiB5PSIxNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSI+VTwvdGV4dD4KPC9zdmc+Cjwvc3ZnPg==" alt="User Avatar" class="user-avatar" id="userAvatar">
                        <span class="user-name" id="displayUserName">Ng∆∞·ªùi d√πng</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="viewProfile()">
                            <span>üë§</span>
                            H·ªì s∆° c·ªßa t√¥i
                        </div>
                        <div class="dropdown-item" onclick="viewBookmarks()">
                            <span>‚ù§Ô∏è</span>
                            Danh s√°ch y√™u th√≠ch
                        </div>
                        <div class="dropdown-item" onclick="viewHistory()">
                            <span>‚è∞</span>
                            L·ªãch s·ª≠ xem
                        </div>
                        <div class="dropdown-item" onclick="logout()">
                            <span>üö™</span>
                            ƒêƒÉng xu·∫•t
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <script>
        'use strict';        // Header specific functionality
        let loadingScreen, notification, navbar, searchInput, searchSuggestions, signInBtn, userMenu, userAvatar, userDropdown, voiceBtn;
        
        // Initialize DOM elements when ready
        function initializeDOMElements() {
            loadingScreen = document.getElementById('loadingScreen');
            notification = document.getElementById('notification');
            navbar = document.getElementById('navbar');
            searchInput = document.getElementById('searchInput');
            searchSuggestions = document.getElementById('searchSuggestions');
            signInBtn = document.getElementById('signInBtn');
            userMenu = document.getElementById('userMenu');
            userAvatar = document.getElementById('userAvatar');
            userDropdown = document.getElementById('userDropdown');
            voiceBtn = document.getElementById('voiceBtn');
            
            console.log('üìã DOM Elements initialized:', {
                signInBtn: !!signInBtn,
                userMenu: !!userMenu,
                userAvatar: !!userAvatar,
                userDropdown: !!userDropdown
            });
        }// State variables - Check for actual login state from localStorage
        let isLoggedIn = checkUserLoginState(); 
        let currentUser = getCurrentUserInfo();
        let bookmarkedMovies = JSON.parse(localStorage.getItem('bookmarkedMovies') || '[]');
        let watchHistory = JSON.parse(localStorage.getItem('watchHistory') || '[]');
        
        // Helper functions to check login state
        function checkUserLoginState() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            return !!(token && username);
        }
        
        function getCurrentUserInfo() {
            return {
                username: localStorage.getItem('username') || '',
                email: localStorage.getItem('email') || '',
                token: localStorage.getItem('token') || ''
            };
        }

        // Sample movie data for search suggestions
        const movies = [
            { title: 'Red Notice', year: '2021', genre: 'H√†nh ƒë·ªông/H√†i' },
            { title: 'Spider-Man: Homecoming', year: '2017', genre: 'H√†nh ƒë·ªông/Th√°m hi·ªÉm' },
            { title: 'Ma Tr·∫≠n: H·ªìi Sinh', year: '2021', genre: 'Khoa h·ªçc vi·ªÖn t∆∞·ªüng/H√†nh ƒë·ªông' },
            { title: 'B·∫•t T·ª≠', year: '2021', genre: 'Phi√™u l∆∞u/H√†nh ƒë·ªông' },
            { title: 'Dune: Ph·∫ßn M·ªôt', year: '2021', genre: 'Khoa h·ªçc vi·ªÖn t∆∞·ªüng/Phi√™u l∆∞u' },
            { title: '1917', year: '2019', genre: 'Chi·∫øn tranh/Ch√≠nh k·ªãch' },
            { title: 'Shang-Chi v√† Huy·ªÅn Tho·∫°i M∆∞·ªùi Chi·∫øc Nh·∫´n', year: '2021', genre: 'H√†nh ƒë·ªông/Gi·∫£ t∆∞·ªüng' },
            { title: 'Casino Royale', year: '2006', genre: 'H√†nh ƒë·ªông/Phi√™u l∆∞u' },
            { title: 'The Dark Knight', year: '2008', genre: 'H√†nh ƒë·ªông/Phi√™u l∆∞u' },
            { title: 'Black Panther', year: '2018', genre: 'H√†nh ƒë·ªông/Phi√™u l∆∞u' },
            { title: 'Venom', year: '2018', genre: 'H√†nh ƒë·ªông/Phi√™u l∆∞u' },
            { title: 'Interstellar', year: '2014', genre: 'Khoa h·ªçc vi·ªÖn t∆∞·ªüng/Phi√™u l∆∞u' }
        ];        // Initialize header
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Header DOM loaded');
            
            // Initialize DOM elements first
            initializeDOMElements();
            
            // Hide loading screen faster
            setTimeout(() => {
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            }, 300);

            initializeHeader();
            
            // Log initial login state
            console.log('üìä Initial header state - isLoggedIn:', isLoggedIn, 'username:', currentUser.username);
            
            // Listen for storage changes (when user logs in from another tab/window)
            window.addEventListener('storage', function(e) {
                if (e.key === 'username' || e.key === 'token') {
                    console.log('üîÑ Storage changed, rechecking login status');
                    setTimeout(() => {
                        isLoggedIn = checkUserLoginState();
                        currentUser = getCurrentUserInfo();
                        checkLoginStatus();
                    }, 100);
                }
            });
              // Also listen for message from parent window
            window.addEventListener('message', function(e) {
                if (e.data && e.data.type === 'userLoggedIn') {
                    console.log('üì¢ Received login message from parent');
                    setTimeout(() => {
                        isLoggedIn = checkUserLoginState();
                        currentUser = getCurrentUserInfo();
                        checkLoginStatus();
                    }, 100);
                } else if (e.data && e.data.type === 'refreshLoginStatus') {
                    console.log('üì¢ Received refresh request from parent');
                    refreshLoginStatus();
                }
            });
        });        function initializeHeader() {
            setupEventListeners();
            checkLoginStatus();
            setupScrollEffects();
            updateLoginButtonHref(); // Update login link href
            
            // Set up periodic check for login status (every 5 seconds)
            setInterval(() => {
                const newLoginState = checkUserLoginState();
                const newUserInfo = getCurrentUserInfo();
                
                // Only update if state has changed
                if (newLoginState !== isLoggedIn || newUserInfo.username !== currentUser.username) {
                    console.log('üîÑ Login state changed, updating header...');
                    isLoggedIn = newLoginState;
                    currentUser = newUserInfo;
                    checkLoginStatus();
                }
            }, 5000);
        }
        
        // Update login button href based on current path
        function updateLoginButtonHref() {
            const signInBtn = document.getElementById('signInBtn');
            if (signInBtn) {
                const loginUrl = getLoginUrl();
                signInBtn.href = loginUrl;
                console.log('Updated login button href to:', loginUrl);
            }
        }

        // ====================================
        // SMART NAVIGATION SYSTEM
        // ====================================

        function smartNavigate(sectionId) {
            const currentPath = getCurrentPageType();
            const sectionName = getSectionDisplayName(sectionId);
            
            console.log('Smart navigation:', sectionId, 'from page:', currentPath);

            if (currentPath === 'home') {
                // ƒêang ·ªü trang ch·ªß - scroll b√¨nh th∆∞·ªùng
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigateToSection',
                        sectionId: sectionId
                    }, '*');
                } else {
                    // Fallback n·∫øu kh√¥ng ph·∫£i iframe
                    scrollToSection(sectionId);
                }
                
                showNotification(`ƒêang ƒë·∫øn: ${sectionName}`, 'success');
            } else {
                // ƒêang ·ªü trang kh√°c - redirect v·ªÅ trang ch·ªß
                const homeUrl = getHomeUrl();
                const targetUrl = sectionId === 'top' ? homeUrl : `${homeUrl}#${sectionId}`;
                
                showNotification(`ƒêang chuy·ªÉn v·ªÅ trang ch·ªß - ${sectionName}`, 'success');
                
                setTimeout(() => {
                    window.top.location.href = targetUrl;
                }, 500);
            }
        }

        function navigateToHome() {
            const currentPath = getCurrentPageType();
            
            if (currentPath === 'home') {
                // ƒêang ·ªü trang ch·ªß - scroll to top
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigateToSection',
                        sectionId: 'top'
                    }, '*');
                } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } else {
                // ƒêang ·ªü trang kh√°c - v·ªÅ trang ch·ªß
                window.top.location.href = getHomeUrl();
            }
            
            showNotification('ƒêang v·ªÅ trang ch·ªß...', 'success');
        }        function navigateToLogin() {
            const loginUrl = getLoginUrl();
            console.log('Navigating to login URL:', loginUrl);
            showNotification('ƒêang chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p...', 'success');
            
            setTimeout(() => {
                // Try multiple navigation methods
                try {
                    // Method 1: Direct window.top navigation
                    if (window.top) {
                        window.top.location.href = loginUrl;
                    } else {
                        // Method 2: Parent window navigation
                        if (window.parent && window.parent !== window) {
                            window.parent.location.href = loginUrl;
                        } else {
                            // Method 3: Current window navigation
                            window.location.href = loginUrl;
                        }
                    }
                } catch (e) {
                    console.log('Navigation error:', e);
                    // Fallback: Send message to parent to handle navigation
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'navigateToLogin',
                            url: loginUrl
                        }, '*');
                    }
                }
            }, 500);
        }

        // Helper functions for smart navigation
        function getCurrentPageType() {
            try {
                const currentPath = window.top.location.pathname;
                const currentHash = window.top.location.hash;
                
                console.log('Current path:', currentPath, 'Hash:', currentHash);
                
                if (currentPath.includes('index.html') || 
                    currentPath.endsWith('/') || 
                    currentPath.includes('/user/') && !currentPath.includes('login')) {
                    return 'home';
                } else if (currentPath.includes('login') || currentPath.includes('register')) {
                    return 'auth';
                } else if (currentPath.includes('movie-detail') || currentPath.includes('watch')) {
                    return 'movie';
                } else {
                    return 'other';
                }
            } catch (e) {
                console.log('Cannot access top window, assuming iframe');
                return 'home';
            }
        }

        function getHomeUrl() {
            try {
                const currentPath = window.top.location.pathname;
                const pathParts = currentPath.split('/');
                
                // Dynamic path building
                if (pathParts.includes('user')) {
                    return './index.html';
                } else if (pathParts.includes('login_register')) {
                    return '../user/index.html';
                } else if (pathParts.includes('movie-details')) {
                    return '../user/index.html';
                } else if (pathParts.includes('admin')) {
                    return '../user/index.html';
                } else {
                    return './index.html';
                }
            } catch (e) {
                return './index.html';
            }        }
        
        function getLoginUrl() {
            try {
                const currentPath = window.top.location.pathname;
                const pathParts = currentPath.split('/');
                
                console.log('Current path for login navigation:', currentPath);
                
                // Check if we're in any subfolder
                if (pathParts.includes('achievements') || 
                    pathParts.includes('genres') || 
                    pathParts.includes('profile') ||
                    pathParts.includes('movie') ||
                    pathParts.includes('admin')) {
                    return '../login_register/login.html';
                } else {
                    // Default case for index.html or root level
                    return './login_register/login.html';
                }
            } catch (e) {
                console.log('Error getting login URL, using fallback');
                return './login_register/login.html';
            }
        }

        function getSectionDisplayName(sectionId) {
            const sectionNames = {
                'top': 'ƒê·∫ßu trang',
                'movies': 'Danh s√°ch phim',
                'achievements': 'Th√†nh t·ª±u',
                'category': 'Th·ªÉ lo·∫°i',
                'live': 'TV Tr·ª±c ti·∫øp'
            };
            
            return sectionNames[sectionId] || sectionId;
        }

        function scrollToSection(sectionId) {
            if (sectionId === 'top') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                const target = document.getElementById(sectionId);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }        // ====================================
        // REST OF HEADER FUNCTIONALITY
        // ====================================

        function setupEventListeners() {
            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
                searchInput.addEventListener('focus', showSearchSuggestions);
            }
              // User menu - CLICK ONLY for better usability
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            if (userInfoDisplay) {
                userInfoDisplay.addEventListener('click', toggleUserDropdown);            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (userMenu && !userMenu.contains(e.target)) {
                    if (userDropdown) {
                        userDropdown.classList.remove('active');
                    }
                }
                if (searchInput && searchSuggestions && 
                    !searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                    hideSearchSuggestions();
                }
            });
        }        function checkLoginStatus() {
            // Update state from localStorage with more robust checking
            isLoggedIn = checkUserLoginState();
            currentUser = getCurrentUserInfo();
            
            console.log('üîç Checking login status:', { 
                isLoggedIn, 
                username: currentUser.username,
                hasSignInBtn: !!signInBtn,
                hasUserMenu: !!userMenu 
            });
            
            // Wait for DOM elements to be available
            const signInBtn = document.getElementById('signInBtn');
            const userMenu = document.getElementById('userMenu');
            
            if (!signInBtn || !userMenu) {
                console.warn('‚è≥ Header elements not ready yet, retrying...');
                setTimeout(() => checkLoginStatus(), 100);
                return;
            }
              if (isLoggedIn && currentUser.username) {
                console.log('‚úÖ User is logged in, showing user menu');
                
                // FORCE HIDE sign in button
                signInBtn.style.display = 'none !important';
                signInBtn.style.visibility = 'hidden';
                signInBtn.style.opacity = '0';
                signInBtn.classList.add('hidden');
                
                // FORCE SHOW user menu
                userMenu.style.display = 'flex !important';
                userMenu.style.visibility = 'visible';
                userMenu.style.opacity = '1';
                userMenu.classList.remove('hidden');
                userMenu.classList.add('visible');
                
                console.log('üîÑ FORCED visibility: signIn=hidden, userMenu=visible');
                
                // Update user name display
                const displayUserName = document.getElementById('displayUserName');
                if (displayUserName) {
                    displayUserName.textContent = currentUser.username;
                    displayUserName.style.display = 'block';
                    console.log('‚úÖ Updated username display to:', currentUser.username);
                } else {
                    console.error('‚ùå displayUserName element not found!');
                }
                
                // Update avatar with first letter
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar && currentUser.username) {
                    const firstLetter = currentUser.username.charAt(0).toUpperCase();
                    // Create dynamic avatar with first letter
                    userAvatar.src = `data:image/svg+xml;base64,${btoa(`
                        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="20" fill="#3498db"/>
                            <text x="20" y="26" text-anchor="middle" font-family="Arial" font-size="16" font-weight="bold" fill="white">${firstLetter}</text>
                        </svg>
                    `)}`;
                    console.log('‚úÖ Updated avatar for:', firstLetter);
                }
                
                // FORCE refresh display
                signInBtn.offsetHeight; // Force reflow
                userMenu.offsetHeight; // Force reflow
                  } else {
                console.log('‚ùå User not logged in, showing sign in button');
                
                // FORCE SHOW sign in button
                signInBtn.style.display = 'flex !important';
                signInBtn.style.visibility = 'visible';
                signInBtn.style.opacity = '1';
                signInBtn.classList.remove('hidden');
                
                // FORCE HIDE user menu
                userMenu.style.display = 'none !important';
                userMenu.style.visibility = 'hidden';
                userMenu.style.opacity = '0';
                userMenu.classList.add('hidden');
                userMenu.classList.remove('visible');
                
                console.log('üîÑ FORCED visibility: signIn=visible, userMenu=hidden');
                
                // Force refresh display
                signInBtn.offsetHeight; // Force reflow
                userMenu.offsetHeight; // Force reflow
            }
        }
        
        // Function to refresh header from external sources
        function refreshLoginStatus() {
            console.log('üîÑ Refreshing header login status...');
            isLoggedIn = checkUserLoginState();
            currentUser = getCurrentUserInfo();
            checkLoginStatus();
        }
        
        // Make function globally accessible for parent window
        window.refreshHeaderLoginStatus = refreshLoginStatus;
        
        // DEBUG: Create visible console on header for testing
        function createDebugConsole() {
            const debugDiv = document.createElement('div');
            debugDiv.id = 'headerDebug';
            debugDiv.style.cssText = `
                position: fixed; 
                top: 0; 
                right: 0; 
                width: 300px; 
                height: 100px; 
                background: rgba(0,0,0,0.8); 
                color: white; 
                font-size: 10px; 
                padding: 5px; 
                z-index: 10000; 
                font-family: monospace;
                overflow-y: auto;
                border-left: 3px solid #00ff00;
            `;
            debugDiv.innerHTML = '<strong>üîç Header Debug:</strong><br>';
            document.body.appendChild(debugDiv);
            
            return debugDiv;
        }
        
        // DEBUG: Log to visible console
        function debugLog(message) {
            console.log(message);
            const debugDiv = document.getElementById('headerDebug');
            if (debugDiv) {
                const time = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `[${time}] ${message}<br>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }
        
        // Create debug console if in debug mode
        if (window.location.search.includes('debug') || window.location.href.includes('test') || window.location.href.includes('debug')) {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    createDebugConsole();
                    debugLog('Header debug console active');
                }, 1000);
            });
        }
        
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length === 0) {
                hideSearchSuggestions();
                return;
            }
            
            showSearchSuggestions(query);
        }

        function showSearchSuggestions(query = '') {
            if (!query || !searchSuggestions) {
                if (searchSuggestions) {
                    searchSuggestions.classList.remove('active');
                }
                return;
            }
            
            const suggestions = movies
                .filter(movie => 
                    movie.title.toLowerCase().includes(query.toLowerCase()) ||
                    movie.genre.toLowerCase().includes(query.toLowerCase())
                )
                .slice(0, 5);
            
            if (suggestions.length > 0) {
                searchSuggestions.innerHTML = suggestions
                    .map(movie => `
                        <div class="suggestion-item" onclick="selectSuggestion('${movie.title}')">
                            ${movie.title} (${movie.year})
                        </div>
                    `).join('');
                searchSuggestions.classList.add('active');
            }
        }

        function selectSuggestion(title) {
            if (searchInput) {
                searchInput.value = title;
            }
            hideSearchSuggestions();
            showNotification(`T√¨m ki·∫øm: "${title}"`, 'success');
            
            // Send search to parent window
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'searchMovie',
                    query: title
                }, '*');
            }
        }

        function hideSearchSuggestions() {
            if (searchSuggestions) {
                searchSuggestions.classList.remove('active');
            }
        }

        function initVoiceSearch() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'vi-VN';
                
                recognition.start();
                showNotification('ƒêang nghe... H√£y n√≥i t√™n phim b·∫°n mu·ªën t√¨m', 'success');
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (searchInput) {
                        searchInput.value = transcript;
                    }
                    showNotification(`T√¨m ki·∫øm: "${transcript}"`, 'success');
                    
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'searchMovie',
                            query: transcript
                        }, '*');
                    }
                };
                
                recognition.onerror = () => {
                    showNotification('Kh√¥ng th·ªÉ nh·∫≠n di·ªán gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                };
            } else {
                showNotification('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ t√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i', 'error');
            }
        }        function toggleUserDropdown() {
            if (userDropdown) {
                const isActive = userDropdown.classList.contains('active');
                
                if (isActive) {
                    userDropdown.classList.remove('active');
                    // Also notify parent to hide any external dropdown
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'hideUserDropdown'
                        }, '*');
                    }
                } else {
                    // Calculate position and show dropdown
                    const userMenuRect = userMenu.getBoundingClientRect();
                    
                    // Try to show dropdown inside iframe first
                    userDropdown.classList.add('active');
                    
                    // Also notify parent with position info for external dropdown if needed
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'showUserDropdown',
                            position: {
                                top: userMenuRect.bottom + 10,
                                right: window.innerWidth - userMenuRect.right,
                                username: currentUser.username
                            }
                        }, '*');
                    }
                }
            }
        }function viewProfile() {
            showNotification('ƒêang chuy·ªÉn ƒë·∫øn trang h·ªì s∆°...', 'success');
            if (userDropdown) {
                userDropdown.classList.remove('active');
            }
            
            // Get correct profile URL based on current path
            const profileUrl = getProfileUrl();
            
            setTimeout(() => {
                window.top.location.href = profileUrl;
            }, 1000);
        }

        function getProfileUrl() {
            try {
                const currentPath = window.top.location.pathname;
                const pathParts = currentPath.split('/');
                
                console.log('Current path for profile navigation:', currentPath);
                
                // Check if we're in any subfolder
                if (pathParts.includes('achievements') || 
                    pathParts.includes('genres') || 
                    pathParts.includes('movie') ||
                    pathParts.includes('admin')) {
                    return '../user/user.html';
                } else if (pathParts.includes('login_register')) {
                    return '../user/user.html';
                } else {
                    // Default case for index.html or root level
                    return './user/user.html';
                }
            } catch (e) {
                console.log('Error getting profile URL, using fallback');
                return './user/user.html';
            }
        }        function viewBookmarks() {
            if (userDropdown) {
                userDropdown.classList.remove('active');
            }
            
            const bookmarkedCount = bookmarkedMovies.length;
            if (bookmarkedCount > 0) {
                showNotification(`B·∫°n c√≥ ${bookmarkedCount} phim y√™u th√≠ch. ƒêang chuy·ªÉn ƒë·∫øn danh s√°ch...`, 'success');
                
                // Navigate to bookmarks section on profile page
                setTimeout(() => {
                    const profileUrl = getProfileUrl() + '#bookmarks';
                    window.top.location.href = profileUrl;
                }, 1000);
            } else {
                showNotification('B·∫°n ch∆∞a c√≥ phim y√™u th√≠ch n√†o. H√£y th√™m phim v√†o danh s√°ch y√™u th√≠ch!', 'info');
            }
        }

        function viewHistory() {
            if (userDropdown) {
                userDropdown.classList.remove('active');
            }
            
            const historyCount = watchHistory.length;
            if (historyCount > 0) {
                showNotification(`B·∫°n ƒë√£ xem ${historyCount} phim. ƒêang chuy·ªÉn ƒë·∫øn l·ªãch s·ª≠...`, 'success');
                
                // Navigate to history section on profile page
                setTimeout(() => {
                    const profileUrl = getProfileUrl() + '#history';
                    window.top.location.href = profileUrl;
                }, 1000);
            } else {
                showNotification('B·∫°n ch∆∞a xem phim n√†o. H√£y b·∫Øt ƒë·∫ßu kh√°m ph√°!', 'info');
            }
        }function logout() {
            // Show confirmation
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                return;
            }
            
            // Clear user data from localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('email');
            localStorage.removeItem('bookmarkedMovies');
            localStorage.removeItem('watchHistory');
            
            // Update state
            isLoggedIn = false;
            currentUser = { username: '', email: '', token: '' };
            
            // Update UI
            checkLoginStatus();
            showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
            
            if (userDropdown) {
                userDropdown.classList.remove('active');
            }
            
            // Send logout message to parent window
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'userLoggedOut'
                }, '*');
            }
            
            // Redirect to login page
            setTimeout(() => {
                const loginUrl = getLoginUrl();
                window.top.location.href = loginUrl;
            }, 1500);
        }

        function setupScrollEffects() {
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset;
                
                if (navbar) {
                    if (scrollTop > 100) {
                        navbar.classList.add('scrolled');
                    } else {
                        navbar.classList.remove('scrolled');
                    }
                }
            });

            // Listen for parent scroll events
            if (window.parent && window.parent !== window) {
                window.addEventListener('message', function(event) {
                    if (event.data.type === 'parentScroll') {
                        const scrollTop = event.data.scrollTop;
                        if (navbar) {
                            if (scrollTop > 100) {
                                navbar.classList.add('scrolled');
                            } else {
                                navbar.classList.remove('scrolled');
                            }
                        }
                    }
                });
            }
        }

        function showNotification(message, type = 'success') {
            if (!notification) {
                const notif = document.createElement('div');
                notif.id = 'notification';
                notif.className = 'notification';
                document.body.appendChild(notif);
            }
            
            const notif = document.getElementById('notification') || notification;
            notif.textContent = message;
            notif.className = `notification ${type} show`;
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                if (searchInput) {
                    searchInput.focus();
                    showNotification('ƒêang t√¨m ki·∫øm...', 'success');
                }
            }
            
            if (e.key === 'Escape') {
                hideSearchSuggestions();
                if (userDropdown) {
                    userDropdown.classList.remove('active');
                }
            }
        });        // Listen for login status updates from parent window or storage changes
        window.addEventListener('message', function(event) {
            console.log('üì• Header received message:', event.data);
            
            if (event.data.type === 'ping') {
                // Respond to ping and trigger immediate login status check
                console.log('üìç Header received ping, responding and checking login status...');
                event.source.postMessage({ type: 'pong' }, '*');
                
                // Force immediate update with aggressive timing
                setTimeout(() => checkLoginStatus(), 5);
                setTimeout(() => checkLoginStatus(), 25);
                setTimeout(() => checkLoginStatus(), 50);
                setTimeout(() => checkLoginStatus(), 100);
                setTimeout(() => checkLoginStatus(), 200);
                return;
            }
            
            if (event.data.type === 'updateLoginStatus') {
                // Update login state from parent
                console.log('üì¶ Updating header login status from message:', event.data);
                isLoggedIn = event.data.isLoggedIn;
                
                if (event.data.userInfo) {
                    currentUser = event.data.userInfo;
                    // Also update localStorage in iframe for consistency
                    if (event.data.userInfo.token) {
                        localStorage.setItem('token', event.data.userInfo.token);
                    }
                    if (event.data.userInfo.username) {
                        localStorage.setItem('username', event.data.userInfo.username);
                    }
                    if (event.data.userInfo.email) {
                        localStorage.setItem('email', event.data.userInfo.email);
                    }
                }
                
                // Force immediate UI update with aggressive timing
                setTimeout(() => checkLoginStatus(), 5);
                setTimeout(() => checkLoginStatus(), 25);
                setTimeout(() => checkLoginStatus(), 50);
                setTimeout(() => checkLoginStatus(), 100);
                setTimeout(() => checkLoginStatus(), 200);
                setTimeout(() => checkLoginStatus(), 500);
                
                console.log('‚úÖ Header login status updated - isLoggedIn:', isLoggedIn, 'username:', currentUser.username);
            }
            
            if (event.data.type === 'loginStatusChanged') {
                console.log('üîÑ Received loginStatusChanged signal');
                // Force refresh from localStorage and update UI
                isLoggedIn = checkUserLoginState();
                currentUser = getCurrentUserInfo();
                
                // Force immediate UI update with aggressive timing
                setTimeout(() => checkLoginStatus(), 5);
                setTimeout(() => checkLoginStatus(), 25);
                setTimeout(() => checkLoginStatus(), 50);
                setTimeout(() => checkLoginStatus(), 100);
                setTimeout(() => checkLoginStatus(), 200);
            }
            
            if (event.data.type === 'forceRefresh') {
                console.log('Received forceRefresh signal');
                isLoggedIn = checkUserLoginState();
                currentUser = getCurrentUserInfo();
                console.log('Force refresh - isLoggedIn:', isLoggedIn, 'username:', currentUser.username);
                setTimeout(() => checkLoginStatus(), 50);
                setTimeout(() => checkLoginStatus(), 200);
                setTimeout(() => checkLoginStatus(), 500);
            }
            
            if (event.data.type === 'updateUserData') {
                bookmarkedMovies = event.data.bookmarkedMovies || [];
                watchHistory = event.data.watchHistory || [];
            }
        });

        // Listen for localStorage changes (when user logs in from another tab)
        window.addEventListener('storage', function(e) {
            if (e.key === 'token' || e.key === 'username') {
                checkLoginStatus();
            }
        });        // Export header functions for use by main page
        window.HeaderApp = {
            showNotification,
            checkLoginStatus,
            initializeTheme,
            smartNavigate,
            navigateToHome,
            viewProfile,
            viewBookmarks,
            viewHistory,
            logout,
            selectSuggestion,
            hideSearchSuggestions,
            updateLoginStatus: checkLoginStatus, // Export for manual refresh
            forceRefresh: function() {
                // Force refresh login status with multiple attempts
                isLoggedIn = checkUserLoginState();
                currentUser = getCurrentUserInfo();
                console.log('Force refresh - isLoggedIn:', isLoggedIn, 'username:', currentUser.username);
                setTimeout(() => checkLoginStatus(), 50);
                setTimeout(() => checkLoginStatus(), 200);
                setTimeout(() => checkLoginStatus(), 500);
            }
        };
          // Add a way to manually refresh login status (for debugging)
        window.refreshLoginStatus = function() {
            console.log('Manual refresh login status called');
            isLoggedIn = checkUserLoginState();
            currentUser = getCurrentUserInfo();
            console.log('Refreshed state - isLoggedIn:', isLoggedIn, 'username:', currentUser.username);
            
            // Multiple check attempts
            setTimeout(() => checkLoginStatus(), 50);
            setTimeout(() => checkLoginStatus(), 200);
            setTimeout(() => checkLoginStatus(), 500);
            
            showNotification('ƒê√£ l√†m m·ªõi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p', 'success');
        };

        // Notification Bell Functionality
        let notificationBell, notificationBtn, notificationDropdown, notificationBadge, notificationList;
        let notifications = [];
        let unreadCount = 0;

        function initializeNotifications() {
            notificationBell = document.getElementById('notificationBell');
            notificationBtn = document.getElementById('notificationBtn');
            notificationDropdown = document.getElementById('notificationDropdown');
            notificationBadge = document.getElementById('notificationBadge');
            notificationList = document.getElementById('notificationList');

            if (!notificationBtn) {
                console.log('Notification elements not found');
                return;
            }

            // Toggle dropdown on click
            notificationBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleNotificationDropdown();
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!notificationBell.contains(e.target)) {
                    closeNotificationDropdown();
                }
            });

            // Mark all as read
            const markAllReadBtn = document.getElementById('markAllRead');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
            }

            // Load notifications if user is logged in
            if (isLoggedIn) {
                loadNotifications();
                // Auto refresh every 30 seconds
                setInterval(loadNotifications, 30000);
            }
        }

        function toggleNotificationDropdown() {
            if (notificationDropdown.classList.contains('show')) {
                closeNotificationDropdown();
            } else {
                openNotificationDropdown();
            }
        }

        function openNotificationDropdown() {
            notificationDropdown.classList.add('show');
            if (isLoggedIn) {
                loadNotifications();
            }
        }

        function closeNotificationDropdown() {
            notificationDropdown.classList.remove('show');
        }

        async function loadNotifications() {
            if (!isLoggedIn) {
                updateNotificationList([]);
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8080/api/notifications', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    notifications = await response.json();
                    updateNotificationList(notifications);
                    updateNotificationBadge();
                } else if (response.status === 401) {
                    console.log('Unauthorized - user not logged in');
                    updateNotificationList([]);
                } else {
                    console.error('Failed to load notifications:', response.status);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function updateNotificationList(notificationArray) {
            if (!notificationList) return;

            if (notificationArray.length === 0) {
                notificationList.innerHTML = `
                    <div class="notification-empty">
                        <div class="notification-empty-icon">üîî</div>
                        <div>Kh√¥ng c√≥ th√¥ng b√°o n√†o</div>
                    </div>
                `;
                return;
            }

            notificationList.innerHTML = notificationArray.map(notification => `
                <div class="notification-item ${!notification.isRead ? 'unread' : ''}" onclick="markNotificationAsRead(${notification.id})">
                    <div class="notification-icon">
                        ${getNotificationIcon(notification.content)}
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">Th√¥ng b√°o m·ªõi</div>
                        <div class="notification-message">${notification.content}</div>
                        <div class="notification-time">${formatNotificationTime(notification.createdAt)}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationBadge() {
            unreadCount = notifications.filter(n => !n.isRead).length;
            
            if (notificationBadge) {
                notificationBadge.textContent = unreadCount;
                
                if (unreadCount > 0) {
                    notificationBadge.classList.add('show');
                    notificationBadge.classList.add('pulse');
                } else {
                    notificationBadge.classList.remove('show');
                    notificationBadge.classList.remove('pulse');
                }
            }
        }

        function getNotificationIcon(content) {
            if (content.includes('like') || content.includes('th√≠ch')) return 'üëç';
            if (content.includes('comment') || content.includes('b√¨nh lu·∫≠n')) return 'üí¨';
            if (content.includes('phim') || content.includes('movie')) return 'üé¨';
            return 'üîî';
        }

        function formatNotificationTime(dateString) {
            if (!dateString) return 'V·ª´a xong';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'V·ª´a xong';
            if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
            if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
            if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
            
            return date.toLocaleDateString('vi-VN');
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:8080/api/notifications/read/${notificationId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // Update local state
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.isRead = true;
                        updateNotificationList(notifications);
                        updateNotificationBadge();
                    }
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllNotificationsAsRead() {
            const unreadNotifications = notifications.filter(n => !n.isRead);
            
            for (const notification of unreadNotifications) {
                await markNotificationAsRead(notification.id);
            }
            
            closeNotificationDropdown();
        }

        function viewAllNotifications() {
            // Navigate to notifications page or open modal
            console.log('View all notifications clicked');
            closeNotificationDropdown();
        }

        // Add notification functionality to main initialization
        const originalInitializeHeader = initializeHeader;
        initializeHeader = function() {
            originalInitializeHeader();
            initializeNotifications();
        };
    </script>
</body>
</html>