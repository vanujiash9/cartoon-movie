<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maxion - Trang phim online tốt nhất</title>

    <!-- Favicon và Meta Tags -->
    <link rel="icon" type="image/x-icon"
        href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEREREREREREREREREREREREQAAAAAAAAABEAERERERERARAAERERERERERAQEREREREREQEQEREREREREQEBERERERERAQEAAREREREQEAAAEREREREAARAAAREREQAAEAEAAREQAAAQABAAEQAAAAEAAQAQAAAAEAARAAABAAAQEAAREAABABABEQEREQEBEQEREREQEBABEREREAAAERERERAAAAAREREREREQERERERERABEQERERERERAQEREREREREQEQERERERERERABERERERERERAREREREREREQEQEREREREREREQEREREREREREQERERERERERERAREREREREREREAERERERERERABAAAAABAAAAAEAABAABAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAg">
    <meta name="description" content="Xem phim online chất lượng cao tại Maxion">
    <meta name="keywords" content="phim online, xem phim, maxion">    <!-- CSS -->
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./header.css">
    <link rel="stylesheet" href="./css/notifications.css">
    <style>
        /* Achievements Widget Styles */
        .achievements-loading {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .achievements-login-required {
            text-align: center;
            padding: 40px 20px;
        }
        
        .login-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            color: white;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .login-prompt h3 {
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .login-prompt p {
            margin-bottom: 25px;
            opacity: 0.9;
        }
        
        .login-btn {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .login-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .achievements-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .achievements-overview {
            margin-bottom: 30px;
        }
        
        .progress-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
        }
        
        .progress-card h4 {
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #00ff88, #00cc6a);
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
        }
        
        .achievement-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .achievement-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .achievement-card.unlocked {
            border-color: #00ff88;
            background: linear-gradient(135deg, #f0fff4 0%, #e6ffed 100%);
        }
        
        .achievement-card.in-progress {
            border-color: #ffa500;
            background: linear-gradient(135deg, #fff8f0 0%, #fff2e6 100%);
        }
        
        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .achievement-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .achievement-icon {
            font-size: 24px;
            margin-right: 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f8f9fa;
        }
        
        .achievement-card.unlocked .achievement-icon {
            background: #00ff88;
            color: white;
        }
        
        .achievement-card.in-progress .achievement-icon {
            background: #ffa500;
            color: white;
        }
        
        .achievement-info h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #333;
        }
        
        .achievement-status {
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .achievement-card.unlocked .achievement-status {
            color: #00cc6a;
        }
        
        .achievement-card.in-progress .achievement-status {
            color: #ff8c00;
        }
        
        .achievement-card.locked .achievement-status {
            color: #888;
        }
        
        .achievement-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .achievement-progress {
            margin-top: 15px;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .progress-label {
            color: #666;
        }
        
        .progress-value {
            font-weight: bold;
            color: #333;
        }
        
        .progress-bar-small {
            background: #e9ecef;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill-small {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .achievement-card.unlocked .progress-fill-small {
            background: linear-gradient(90deg, #00ff88, #00cc6a);
        }
        
        .achievement-card.in-progress .progress-fill-small {
            background: linear-gradient(90deg, #ffa500, #ff8c00);
        }
        
        .achievements-share {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .achievements-share p {
            margin-bottom: 20px;
            color: #666;
        }
        
        .share-demo-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .share-demo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .progress-stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .achievement-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Integrated Header (No iframe) -->
    <header>
        <div class="navbar" id="navbar">
            <a href="#" class="navbar-brand" onclick="scrollToTop()">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMTQwIDQwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8dGV4dCB4PSIyMCIgeT0iMjgiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiMzNDk4ZGIiPk1heGlvbjwvdGV4dD4KPC9zdmc+"
                    alt="Maxion Logo">
            </a>

            <nav id="navMenu">
                <ul class="navbar-nav">
                    <li><a href="#" class="navbar-link" onclick="scrollToSection('top')">Trang chủ</a></li>
                    <li><a href="#" class="navbar-link" onclick="scrollToSection('movies')">Danh sách phim</a></li>
                    <li><a href="#" class="navbar-link indicator" onclick="scrollToSection('achievements')">Thành
                            tựu</a></li>
                    <li><a href="#" class="navbar-link" onclick="scrollToSection('category')">Thể loại</a></li>
                    <li><a href="#" class="navbar-link" onclick="scrollToSection('live')">TV Trực tiếp</a></li>
                </ul>
            </nav>

            <div class="navbar-actions">
                <form class="navbar-form" id="searchForm">
                    <input type="text" name="search" placeholder="Tìm kiếm phim..." class="navbar-form-search"
                        id="searchInput">
                    <button type="button" class="navbar-form-btn" id="searchBtn">
                        <span style="font-size: 18px;">🔍</span>
                    </button>
                    <div class="search-suggestions" id="searchSuggestions"></div>
                </form>

                <button class="voice-btn" id="voiceBtn" title="Tìm kiếm bằng giọng nói">
                    <span>🎤</span>
                </button>                <!-- Notification Bell -->
                <div class="notification-bell" id="notificationBell"
                    style="position: relative; margin-right: 16px; cursor: pointer;">
                    <span style="font-size: 22px; transition: transform 0.2s;">🔔</span>
                    <span id="notificationBadge"
                        style="position: absolute; top: -4px; right: -4px; background: #ff4757; color: white; border-radius: 50%; font-size: 11px; padding: 2px 6px; display: none; min-width: 18px; text-align: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">0</span>
                    <div id="notificationDropdown" class="notification-dropdown"
                        style="position: absolute; right: 0; top: 32px; background: #fff; color: #222; min-width: 350px; max-width: 400px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); border-radius: 12px; z-index: 1000; border: 1px solid #e9ecef; overflow: hidden;">
                        <div style="padding: 16px; font-weight: 600; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                            <span>🔔 Thông báo</span>
                            <span id="notificationCount" style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; font-size: 12px;">0</span>
                        </div>
                        <div id="notificationList" style="max-height: 400px; overflow-y: auto;">
                            <div style="padding: 20px; text-align: center; color: #888;">
                                <div style="font-size: 24px; margin-bottom: 8px;">📭</div>
                                <div>Đang tải thông báo...</div>
                            </div>
                        </div>
                        <div style="padding: 12px; text-align: center; border-top: 1px solid #eee; background: #f8f9fa;">
                            <a href="#" onclick="markAllNotificationsRead(); return false;"
                                style="color: #667eea; font-size: 14px; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 6px; transition: all 0.2s; display: inline-block;"
                                onmouseover="this.style.background='#667eea'; this.style.color='white';"
                                onmouseout="this.style.background='transparent'; this.style.color='#667eea';">
                                ✓ Đánh dấu tất cả đã đọc
                            </a>
                        </div>
                    </div>
                </div><!-- Sign In Button (shown when NOT logged in) -->
                <a href="./login-register/login.html" class="navbar-signin" id="signInBtn">
                    <span id="signInText">Đăng nhập</span>
                    <span style="margin-left: 8px;">➡️</span>
                </a>

                <!-- User Menu (shown when logged in) -->
                <div class="user-menu" id="userMenu" style="display: none;">
                    <div class="user-info-display" id="userInfoDisplay">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+Cjx0ZXh0IHg9IjEwIiB5PSIxNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSI+VTwvdGV4dD4KPC9zdmc+Cjwvc3ZnPg=="
                            alt="User Avatar" class="user-avatar" id="userAvatar">
                        <span class="user-name" id="displayUserName">Người dùng</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="viewProfile()">
                            <span>👤</span>
                            Hồ sơ của tôi
                        </div>
                        <div class="dropdown-item" onclick="viewBookmarks()">
                            <span>❤️</span>
                            Danh sách yêu thích
                        </div>
                        <div class="dropdown-item" onclick="viewHistory()">
                            <span>⏰</span>
                            Lịch sử xem
                        </div>
                        <div class="dropdown-item" onclick="logout()">
                            <span>🚪</span>
                            Đăng xuất
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <section class="banner">
                <div class="banner-card" onclick="playBannerMovie()">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTAwIiBoZWlnaHQ9IjUwMCIgdmlld0JveD0iMCAwIDkwMCA1MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI5MDAiIGhlaWdodD0iNTAwIiBmaWxsPSJ1cmwoI2dyYWRpZW50MCkiLz4KPHN0eWxlPgouYmFubmVyLXRleHQgeyBmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7IGZvbnQtd2VpZ2h0OiBib2xkOyBmaWxsOiB3aGl0ZTsgfQo8L3N0eWxlPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDAiIHgxPSIwIiB5MT0iMCIgeDI9IjkwMCIgeTI9IjUwMCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjMWUzYzcyIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzJhNTI5OCIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjx0ZXh0IHg9IjQ1MCIgeT0iMjMwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBjbGFzcz0iYmFubmVyLXRleHQiIGZvbnQtc2l6ZT0iNDgiPkpvaG4gV2ljayAzPC90ZXh0Pgo8dGV4dCB4PSI0NTAiIHk9IjI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgY2xhc3M9ImJhbm5lci10ZXh0IiBmb250LXNpemU9IjE4Ij5QYXJhYmVsbHVtPC90ZXh0Pgo8L3N2Zz4="
                        alt="John Wick 3 Banner" class="banner-img">

                    <div class="banner-play-btn">
                        <span>▶</span>
                    </div>

                    <div class="card-content">
                        <div class="card-info">
                            <div class="genre">
                                <span>🎬 Hành động/Thriller</span>
                            </div>

                            <div class="year">
                                <span>📅 2019</span>
                            </div>

                            <div class="duration">
                                <span>⏱️ 2h 11phút</span>
                            </div>

                            <div class="quality">4K</div>
                        </div>
                        <h2 class="card-title">John Wick: Chapter 3 - Parabellum</h2>
                    </div>
                </div>
            </section>

            <section class="movies" id="movies">
                <h2 class="section-heading">Phim Hot</h2>

                <div class="filter-bar">
                    <div class="filter-dropdowns">
                        <select name="genre" class="genre" id="genreFilter">
                            <option value="all">Tất cả thể loại</option>
                            <option value="action">Hành động</option>
                            <option value="adventure">Phiêu lưu</option>
                            <option value="animation">Hoạt hình</option>
                            <option value="comedy">Hài</option>
                            <option value="drama">Chính kịch</option>
                            <option value="fantasy">Giả tưởng</option>
                            <option value="horror">Kinh dị</option>
                            <option value="scifi">Khoa học viễn tưởng</option>
                            <option value="war">Chiến tranh</option>
                        </select>

                        <select name="year" class="year" id="yearFilter">
                            <option value="all">Tất cả năm</option>
                            <option value="2024">2024</option>
                            <option value="2020-2023">2020-2023</option>
                            <option value="2010-2019">2010-2019</option>
                            <option value="2000-2009">2000-2009</option>
                            <option value="1980-1999">1980-1999</option>
                        </select>
                    </div>

                    <div class="filter-radios">
                        <input type="radio" name="grade" id="featured" checked>
                        <label for="featured">Đặc biệt</label>

                        <input type="radio" name="grade" id="popular">
                        <label for="popular">Phổ biến</label>

                        <input type="radio" name="grade" id="newest">
                        <label for="newest">Mới nhất</label>

                        <div class="checked-radio-bg"></div>
                    </div>
                </div>

                <div class="movies-grid" id="moviesGrid">
                    <!-- Movies will be populated by JavaScript -->
                </div>
                <button class="load-more" id="loadMore">TẢI THÊM</button>
            </section>

            <section class="category" id="category">
                <h2 class="section-heading">Thể loại</h2>

                <div class="category-grid">
                    <div class="category-card category-action" onclick="filterByCategory('action')">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMTgwIiBmaWxsPSIjZGMyNjI2Ii8+Cjx0ZXh0IHg9IjE1MCIgeT0iOTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiPkjDoG5oIMSR4buZbmc8L3RleHQ+Cjwvc3ZnPg=="
                            alt="Hành động" class="card-img">
                        <div class="name">Hành động</div>
                        <div class="total">120</div>
                    </div>

                    <div class="category-card category-comedy" onclick="filterByCategory('comedy')">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMTgwIiBmaWxsPSIjZjM5YzEyIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iOTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiPkjDoGk8L3RleHQ+Cjwvc3ZnPg=="
                            alt="Hài" class="card-img">
                        <div class="name">Hài</div>
                        <div class="total">85</div>
                    </div>

                    <div class="category-card category-thriller" onclick="filterByCategory('thriller')">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMTgwIiBmaWxsPSIjNzQzZjM5Ii8+Cjx0ZXh0IHg9IjE1MCIgeT0iOTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiPlRocmlsbGVyPC90ZXh0Pgo8L3N2Zz4="
                            alt="Thriller" class="card-img">
                        <div class="name">Thriller</div>
                        <div class="total">45</div>
                    </div>

                    <div class="category-card category-horror" onclick="filterByCategory('horror')">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMTgwIiBmaWxsPSIjMmMzZTUwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iOTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiPktpbmcgxJHhu4s8L3RleHQ+Cjwvc3ZnPg=="
                            alt="Kinh dị" class="card-img">
                        <div class="name">Kinh dị</div>
                        <div class="total">60</div>
                    </div>

                    <div class="category-card category-adventure" onclick="filterByCategory('adventure')">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMTgwIiBmaWxsPSIjMjc4NGU3Ii8+Cjx0ZXh0IHg9IjE1MCIgeT0iOTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiPlBoaWV1IGzGsOG7pW5nPC90ZXh0Pgo8L3N2Zz4="
                            alt="Phiêu lưu" class="card-img">
                        <div class="name">Phiêu lưu</div>
                        <div class="total">95</div>
                    </div>

                    <div class="category-card category-animation" onclick="filterByCategory('animation')">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMTgwIiBmaWxsPSIjZWQ0ODEyIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iOTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiPkhv4bqhdCBow6xuaDwvdGV4dD4KPC9zdmc+"
                            alt="Hoạt hình" class="card-img">
                        <div class="name">Hoạt hình</div>
                        <div class="total">70</div>
                    </div>

                    <div class="category-card category-crime" onclick="filterByCategory('crime')">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMTgwIiBmaWxsPSIjMzQzYTQwIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iOTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiPlThu5lpIHBo4bqhbTwvdGV4dD4KPC9zdmc+"
                            alt="Tội phạm" class="card-img">
                        <div class="name">Tội phạm</div>
                        <div class="total">35</div>
                    </div>

                    <div class="category-card category-scifi" onclick="filterByCategory('scifi')">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMTgwIiBmaWxsPSIjOWI1OWI2Ii8+Cjx0ZXh0IHg9IjE1MCIgeT0iOTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiPlNjaS1GaTwvdGV4dD4KPC9zdmc+"
                            alt="Khoa học viễn tưởng" class="card-img">
                        <div class="name">Sci-fi</div>
                        <div class="total">55</div>
                    </div>
                </div>
            </section>            <section class="achievements" id="achievements">
                <h2 class="section-heading">Thành tựu của bạn</h2>
                
                <!-- Loading state -->
                <div id="achievementsLoading" class="achievements-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Đang tải thành tựu...</p>
                </div>
                
                <!-- Login required state -->
                <div id="achievementsLoginRequired" class="achievements-login-required" style="display: none;">
                    <div class="login-prompt">
                        <h3>🔒 Vui lòng đăng nhập để xem thành tựu</h3>
                        <p>Đăng nhập để theo dõi tiến độ và mở khóa các thành tựu đặc biệt!</p>
                        <a href="./login_register/login.html" class="login-btn">Đăng nhập ngay</a>
                    </div>
                </div>
                
                <!-- Achievements content -->
                <div id="achievementsContent" class="achievements-content" style="display: none;">
                    <!-- Progress overview -->
                    <div class="achievements-overview">
                        <div class="progress-card">
                            <h4>Tổng quan tiến độ</h4>
                            <div class="progress-stats">
                                <div class="stat">
                                    <span class="stat-value" id="unlockedCount">0</span>
                                    <span class="stat-label">Đã mở khóa</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value" id="totalCount">10</span>
                                    <span class="stat-label">Tổng cộng</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value" id="progressPercent">0%</span>
                                    <span class="stat-label">Hoàn thành</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Achievement cards -->
                    <div class="achievement-cards-container">
                        <div class="achievement-cards" id="achievementCards">
                            <!-- Thành tựu sẽ được load từ backend -->
                        </div>
                    </div>                      <!-- Share feature -->
                    <div class="achievements-share">
                        <p>Chia sẻ phim để mở khóa thành tựu mới!</p>
                        <button class="share-demo-btn" onclick="openShareDemo()">
                            📱 Thử chia sẻ phim
                        </button>
                        <button class="share-demo-btn" onclick="debugAchievements()" style="background: #e74c3c; margin-left: 10px;">
                            🔍 Debug Achievements
                        </button>
                        
                        <!-- Notification Test Buttons -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                            <p style="margin-bottom: 15px; color: #666;">🔔 Test Notification System:</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                <button onclick="createTestNotification('LIKE', 'Test Like', 'Ai đó đã thích bình luận của bạn')" 
                                    style="background: #FF6B6B; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    ❤️ Test Like
                                </button>
                                <button onclick="createTestNotification('COMMENT', 'Test Comment', 'Có bình luận mới trên phim bạn đã xem')" 
                                    style="background: #4ECDC4; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    💬 Test Comment
                                </button>
                                <button onclick="createTestNotification('ACHIEVEMENT', 'Thành tựu mới!', 'Bạn đã mở khóa thành tựu: Người xem tích cực')" 
                                    style="background: #FFD700; color: #333; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    🏆 Test Achievement
                                </button>
                                <button onclick="createTestNotification('SUCCESS', 'Cập nhật thành công', 'Thông tin cá nhân đã được cập nhật')" 
                                    style="background: #00B894; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    ✅ Test Success
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Include Footer -->
    <iframe src="./footer.html" class="footer-frame" id="footerFrame" onload="initFooterIframe()"></iframe>    <!-- Load JavaScript -->
    <script src="./script.js"></script>
    <script src="./js/shared-api.js"></script>
    <script src="./js/notifications.js"></script>
    <script>
        // Achievements Integration        let achievementsData = null;
        let isLoadingAchievements = false; // Prevent multiple simultaneous loads
        let debounceTimeout = null; // For debouncing function calls
        
        // Initialize achievements when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Page loaded, initializing achievements...');
            
            // Add achievements loading after other initial loads
            setTimeout(() => {
                console.log('⏰ First attempt to load achievements...');
                loadUserAchievements();
            }, 1000);
            
            // Try again after a longer delay in case authentication is slow
            setTimeout(() => {
                console.log('⏰ Second attempt to load achievements...');
                if (!achievementsData) { // Only if not already loaded
                    loadUserAchievements();
                }
            }, 3000);
              // Listen for login status changes
            window.addEventListener('storage', function(e) {
                if (e.key === 'token' || e.key === 'username') {
                    console.log('🔄 Storage changed, reloading achievements...', e.key, e.newValue);
                    setTimeout(() => {
                        if (!isLoadingAchievements) { // Prevent multiple calls
                            loadUserAchievementsDebounced(); // Use debounced version
                        }
                    }, 500);
                }
            });
              // Listen for focus events (when user comes back to tab) - reduced frequency
            let lastFocusTime = 0;
            window.addEventListener('focus', function() {
                const now = Date.now();
                if (now - lastFocusTime > 5000) { // Only check every 5 seconds
                    console.log('👁️ Window focus, checking achievements...');
                    lastFocusTime = now;
                    setTimeout(() => {
                        if (!isLoadingAchievements) {
                            loadUserAchievementsDebounced(); // Use debounced version
                        }
                    }, 1000);
                }
            });
        });
        
        // Debounced version of loadUserAchievements
        function loadUserAchievementsDebounced() {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                loadUserAchievements();
            }, 300); // Wait 300ms before actually calling
        }
        
        async function loadUserAchievements() {
            // Prevent multiple simultaneous calls
            if (isLoadingAchievements) {
                console.log('🔒 Already loading achievements, skipping...');
                return;
            }
            
            isLoadingAchievements = true;
            
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            
            console.log('🔍 Loading achievements...');
            console.log('Token:', token ? `Present (${token.substring(0, 20)}...)` : 'None');
            console.log('Username:', username || 'None');
            
            const loadingEl = document.getElementById('achievementsLoading');
            const loginRequiredEl = document.getElementById('achievementsLoginRequired');
            const contentEl = document.getElementById('achievementsContent');
            
            // Show loading
            loadingEl.style.display = 'block';
            loginRequiredEl.style.display = 'none';
            contentEl.style.display = 'none';
            
            if (!token || !username) {
                console.log('❌ No token or username - showing login required');
                // Show login required
                loadingEl.style.display = 'none';
                loginRequiredEl.style.display = 'block';
                return;
            }
            
            try {
                console.log('✅ Token and username found, proceeding...');
                
                // First get user ID from /me endpoint
                let userId = localStorage.getItem('userId');
                console.log('Cached userId:', userId || 'None');
                
                if (!userId) {
                    console.log('📡 Fetching user info from /api/users/me...');
                    // Try to get user info from backend
                    const userResponse = await fetch(`http://localhost:8080/api/users/me`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    console.log('User API response status:', userResponse.status);
                    
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        console.log('User data received:', userData);
                        userId = userData.id;
                        localStorage.setItem('userId', userId);
                        console.log('✅ User ID retrieved and saved:', userId);
                    } else {
                        const errorText = await userResponse.text();
                        console.error('❌ User API error:', errorText);
                        throw new Error('Cannot get user ID - API error: ' + userResponse.status);
                    }
                }
                  console.log('📡 Fetching achievements for userId:', userId);
                // Try the correct endpoint for user achievements with progress
                const response = await fetch(`http://localhost:8080/api/achievements/progress/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Achievements API response status:', response.status);
                  if (!response.ok) {
                    console.log('📡 Primary endpoint failed, trying fallback...');
                    // Try fallback endpoint
                    const fallbackResponse = await fetch(`http://localhost:8080/api/user-achievements/username/${username}/detailed-progress`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (fallbackResponse.ok) {
                        achievementsData = await fallbackResponse.json();
                        console.log('✅ Achievements loaded from fallback:', achievementsData);
                    } else {
                        const errorText = await fallbackResponse.text();
                        console.error('❌ Both endpoints failed. Fallback error:', errorText);
                        throw new Error(`Both achievements API endpoints failed: ${response.status} / ${fallbackResponse.status}`);
                    }
                } else {
                    achievementsData = await response.json();
                    console.log('✅ Achievements loaded from primary endpoint:', achievementsData);
                }
                
                // Extract data array from response object
                let achievementsArray;
                if (Array.isArray(achievementsData)) {
                    achievementsArray = achievementsData;
                } else if (achievementsData.data && Array.isArray(achievementsData.data)) {
                    achievementsArray = achievementsData.data;
                } else {
                    throw new Error('Invalid achievements data format');
                }
                
                console.log('📊 Extracted achievements array:', achievementsArray);
                
                // Show content and render achievements
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
                  renderAchievements(achievementsArray);
                
            } catch (error) {
                console.error('❌ Failed to load achievements:', error);
                console.error('Error details:', error.message);
                
                // Show login required as fallback
                loadingEl.style.display = 'none';
                loginRequiredEl.style.display = 'block';
                
                // Show error details in console for debugging
                console.log('=== DEBUG INFO ===');
                console.log('Token exists:', !!token);
                console.log('Username exists:', !!username);
                console.log('Full error:', error);
            } finally {
                // Always reset loading flag
                isLoadingAchievements = false;
            }
        }function renderAchievements(data) {
            console.log('🎨 renderAchievements called with data:', data);
            
            // Validate input
            if (!Array.isArray(data)) {
                console.error('❌ Invalid data passed to renderAchievements. Expected array, got:', typeof data, data);
                return;
            }
            
            console.log('✅ Valid array with', data.length, 'achievements');
              // Update progress overview - use completed field from backend
            const unlockedCount = data.filter(a => {
                return a.completed === true; // Use completed field from backend
            }).length;
            const totalCount = data.length;
            const progressPercent = totalCount > 0 ? Math.round((unlockedCount / totalCount) * 100) : 0;
            
            console.log('📊 Progress stats:', { unlockedCount, totalCount, progressPercent });
              // Safely update DOM elements
            const unlockedEl = document.getElementById('unlockedCount');
            const totalEl = document.getElementById('totalCount');
            const percentEl = document.getElementById('progressPercent');
            const fillEl = document.getElementById('progressFill');
            
            console.log('🔍 DOM elements found:', {
                unlockedEl: !!unlockedEl,
                totalEl: !!totalEl,
                percentEl: !!percentEl,
                fillEl: !!fillEl
            });
            
            if (unlockedEl) unlockedEl.textContent = unlockedCount;
            if (totalEl) totalEl.textContent = totalCount;
            if (percentEl) percentEl.textContent = progressPercent + '%';
            if (fillEl) fillEl.style.width = progressPercent + '%';
            
            // Render achievement cards
            const cardsContainer = document.getElementById('achievementCards');
            if (!cardsContainer) {
                console.error('❌ Achievement cards container not found!');
                return;
            }
            
            cardsContainer.innerHTML = '';
              data.forEach((achievement, index) => {
                console.log(`🏆 Rendering achievement ${index + 1}:`, {
                    name: achievement.name || achievement.title || `Achievement ${index + 1}`,
                    progress: `${achievement.currentProgress || achievement.progress || 0}/${achievement.targetProgress || achievement.target || 0}`,
                    unlocked: achievement.unlocked || achievement.isUnlocked || false
                });
                
                try {
                    const card = createAchievementCard(achievement);
                    if (card && card.nodeType === Node.ELEMENT_NODE) {
                        cardsContainer.appendChild(card);
                        console.log(`✅ Successfully added achievement card ${index + 1}`);
                    } else {
                        console.error(`❌ Invalid card element for achievement ${index + 1}:`, card);
                    }
                } catch (error) {
                    console.error(`❌ Error creating achievement card ${index + 1}:`, error);
                }
            });
            
            console.log('✅ All achievements rendered successfully');
        }
          function createAchievementCard(achievement) {
            const card = document.createElement('div');
            card.className = 'achievement-card';
              console.log('🔍 Creating card for achievement:', achievement);
            
            // Backend trả về: name, description, progressPercent, id, completed
            // Safely get values with fallbacks
            const achievementName = achievement.name || achievement.title || 'Thành tựu';
            const achievementDescription = achievement.description || 'Mô tả thành tựu';
            const achievementType = achievement.type || achievement.achievementType || 'UNKNOWN';
            const isCompleted = achievement.completed || false;
            const progressPercent = achievement.progressPercent || 0;
            
            // Extract target from description and calculate current progress
            const targetProgress = getTargetFromDescription(achievementDescription);
            const currentProgress = isCompleted ? targetProgress : Math.floor((progressPercent / 100) * targetProgress);
            const isUnlocked = isCompleted;
            
            console.log('📊 Progress data:', {
                name: achievementName,
                completed: isCompleted,
                progressPercent,
                currentProgress,
                targetProgress,
                isUnlocked,
                type: achievementType
            });
            
            // Determine status
            let status = 'locked';
            if (isUnlocked) {
                status = 'unlocked';
            } else if (currentProgress > 0) {
                status = 'in-progress';
            }
            
            card.classList.add(status);
              // Calculate progress percentage for display
            const displayProgressPercent = Math.min(100, Math.round((currentProgress / targetProgress) * 100));
            
            // Status text
            let statusText = 'CHƯA MỞ KHÓA';
            if (isUnlocked) {
                statusText = '✅ ĐÃ MỞ KHÓA';
            } else if (currentProgress > 0) {
                statusText = '🔄 ĐANG TIẾN HÀNH';
            }
            
            // Achievement icon
            const iconMap = {
                'FIRST_MOVIE': '🎬',
                'MOVIE_MARATHON': '🍿',
                'WEEK_STREAK': '📅',
                'FIRST_REVIEW': '✍️',
                'REVIEW_EXPERT': '📝',
                'LIKED_REVIEWER': '👍',
                'SOCIAL_SHARER': '📱',
                'VIRAL_SHARER': '🚀',
                'FRIEND_INVITER': '👥',
                'COMMUNITY_BUILDER': '🏆'
            };
            
            const icon = iconMap[achievementType] || '🏅';
            
            card.innerHTML = `
                <div class="achievement-header">
                    <div class="achievement-icon">${icon}</div>
                    <div class="achievement-info">
                        <h4>${achievementName}</h4>
                        <div class="achievement-status">${statusText}</div>
                    </div>
                </div>
                <div class="achievement-description">
                    ${achievementDescription}
                </div>
                <div class="achievement-progress">
                    <div class="progress-text">
                        <span class="progress-label">Tiến độ</span>
                        <span class="progress-value">${currentProgress}/${targetProgress}</span>
                    </div>                    <div class="progress-bar-small">
                        <div class="progress-fill-small" style="width: ${displayProgressPercent}%"></div>
                    </div></div>
            `;
            
            return card;
        }
        
        // Helper function to extract target numbers from achievement descriptions
        function getTargetFromDescription(description) {
            // Common patterns in achievement descriptions
            const patterns = [
                /(\d+)\s*phim/i,           // "X phim"
                /(\d+)\s*review/i,         // "X review"
                /(\d+)\s*like/i,           // "X like"
                /(\d+)\s*lần/i,            // "X lần"
                /(\d+)\s*người/i,          // "X người"
                /(\d+)\s*bộ/i,             // "X bộ"
                /(\d+)\s*tuần/i,           // "X tuần"
                /xem\s*(\d+)/i,            // "xem X"
                /viết\s*(\d+)/i,           // "viết X"
                /nhận\s*(\d+)/i,           // "nhận X"
                /chia sẻ\s*(\d+)/i,        // "chia sẻ X"
                /mời\s*(\d+)/i,            // "mời X"
            ];
            
            for (const pattern of patterns) {
                const match = description.match(pattern);
                if (match) {
                    return parseInt(match[1]);
                }
            }
            
            // Default fallback values based on achievement type
            if (description.includes('phim') || description.includes('movie') || description.includes('bộ')) return 10;
            if (description.includes('review') || description.includes('đánh giá')) return 5;
            if (description.includes('like') || description.includes('thích')) return 20;
            if (description.includes('chia sẻ') || description.includes('share')) return 3;
            if (description.includes('bạn bè') || description.includes('mời') || description.includes('friend')) return 5;
            if (description.includes('tuần') || description.includes('week')) return 7;
            
            return 1; // Default fallback
        }        // Debug function
        function debugAchievements() {
            console.log('=== ACHIEVEMENTS DEBUG ===');
            console.log('localStorage token:', localStorage.getItem('token'));
            console.log('localStorage username:', localStorage.getItem('username'));
            console.log('localStorage userId:', localStorage.getItem('userId'));
            console.log('localStorage email:', localStorage.getItem('email'));
            
            // Check DOM elements
            console.log('DOM elements check:');
            console.log('achievementCards:', document.getElementById('achievementCards'));
            console.log('unlockedCount:', document.getElementById('unlockedCount'));
            console.log('totalCount:', document.getElementById('totalCount'));
            console.log('progressPercent:', document.getElementById('progressPercent'));
            console.log('progressFill:', document.getElementById('progressFill'));
            
            // Show raw achievements data
            if (achievementsData) {
                console.log('🎯 Raw achievements data from API:');
                console.log(JSON.stringify(achievementsData, null, 2));
                
                console.log('🎯 Individual achievement details:');
                const dataArray = Array.isArray(achievementsData) ? achievementsData : achievementsData.data;
                if (dataArray) {
                    dataArray.forEach((achievement, index) => {
                        console.log(`Achievement ${index + 1}:`, {
                            name: achievement.name,
                            type: achievement.type,
                            description: achievement.description,
                            completed: achievement.completed,
                            progressPercent: achievement.progressPercent,
                            rawData: achievement
                        });
                    });
                } else {
                    console.log('❌ No data array found in achievementsData');
                }
            } else {
                console.log('❌ No achievements data available');
            }
            
            // Show all localStorage items
            console.log('All localStorage items:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`  ${key}: ${value}`);
            }
            
            // Try to reload achievements
            console.log('Attempting to reload achievements...');
            loadUserAchievements();
            
            alert('Đã ghi log debug vào Console. Mở Developer Tools (F12) để xem chi tiết data structure.');
        }
        
        // Force reload achievements function
        function forceReloadAchievements() {
            console.log('🔄 Force reloading achievements...');
            loadUserAchievements();
        }
          // Global debug functions
        window.debugAchievements = debugAchievements;
        window.forceReloadAchievements = forceReloadAchievements;
        window.loadUserAchievements = loadUserAchievements;
        
        // Prevent accidental reloads
        window.addEventListener('beforeunload', function(e) {
            // Only show warning if user is in middle of something important
            if (isLoadingAchievements) {
                e.preventDefault();
                e.returnValue = '';
                return 'Đang tải thành tựu, bạn có chắc muốn rời khỏi trang?';
            }
        });
        
        // Prevent form submissions that might cause reload
        document.addEventListener('submit', function(e) {
            e.preventDefault();
            console.warn('Form submission prevented to avoid page reload');
            return false;
        });
        
        // Share demo function
        function openShareDemo() {
            // Simple share demo for testing
            const demoCartoonId = 2; // Use a known cartoon ID
            const platforms = ['facebook', 'twitter', 'whatsapp'];
            const platform = platforms[Math.floor(Math.random() * platforms.length)];
            
            if (confirm(`Bạn có muốn chia sẻ phim ID ${demoCartoonId} trên ${platform}?`)) {
                shareMovieDemo(demoCartoonId, platform);
            }
        }        async function shareMovieDemo(cartoonId, platform) {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            
            if (!token || !username) {
                alert('Vui lòng đăng nhập để chia sẻ!');
                return;
            }
            
            try {
                // Get userId
                let userId = localStorage.getItem('userId');
                
                if (!userId) {
                    const userResponse = await fetch(`http://localhost:8080/api/users/me`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        userId = userData.id;
                        localStorage.setItem('userId', userId);
                    } else {
                        throw new Error('Cannot get user ID');
                    }
                }
                
                // Record share
                const response = await fetch('http://localhost:8080/api/social/share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        cartoonId: parseInt(cartoonId),
                        platform: platform
                    })
                });
                
                if (response.ok) {
                    alert(`✅ Đã chia sẻ phim trên ${platform}! Kiểm tra thành tựu mới.`);
                    
                    // Reload achievements after share
                    setTimeout(() => {
                        loadUserAchievements();
                    }, 1000);
                } else {
                    const error = await response.text();
                    console.error('Share error:', error);
                    alert('❌ Không thể chia sẻ. Vui lòng thử lại.');
                }
            } catch (error) {
                console.error('Share error:', error);
                alert('❌ Lỗi chia sẻ: ' + error.message);
            }
        }
          // Scroll to achievements section
        function scrollToAchievements() {
            document.getElementById('achievements').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }
        
        // Override scrollToSection to handle achievements
        const originalScrollToSection = window.scrollToSection;
        window.scrollToSection = function(sectionId) {
            if (sectionId === 'achievements') {
                scrollToAchievements();
            } else {
                originalScrollToSection(sectionId);
            }
        };    </script>
    <!-- <script src="./js/achievements.js"></script> <!-- DISABLED: Using integrated achievements logic instead -->

    <!-- Integrated Header JavaScript -->
    <script>
        // Header Variables
        let isHeaderLoggedIn = false;
        let currentHeaderUser = {};
        // Check login status
        function checkHeaderLoginStatus() {
            const userInfo = localStorage.getItem('userInfo');
            const username = localStorage.getItem('username');

            console.log('🔍 Checking header login status:', { userInfo: !!userInfo, username });

            // Check if user is logged in by looking for userInfo or username
            isHeaderLoggedIn = !!(userInfo || username);

            let userData = {};
            if (userInfo) {
                try {
                    userData = JSON.parse(userInfo);
                } catch (e) {
                    console.error('Error parsing userInfo:', e);
                }
            }

            currentHeaderUser = {
                username: userData.username || username || '',
                email: userData.email || localStorage.getItem('email') || '',
                fullName: userData.fullName || localStorage.getItem('fullName') || '',
                id: userData.id || localStorage.getItem('userId') || ''
            };

            updateHeaderUI();
        }        // Update header UI - DISABLED to avoid conflict with script.js
        function updateHeaderUI() {
            console.log('🎯 index.html updateHeaderUI() called but DISABLED to avoid conflict with script.js');
            console.log('🎯 Let script.js handle all header updates');
            
            // All header logic is now handled by script.js to avoid conflicts
            // This prevents the username/fullName flickering issue
            return;
            
            /* DISABLED CODE:
            const signInBtn = document.getElementById('signInBtn');
            const userMenu = document.getElementById('userMenu');
            const displayUserName = document.getElementById('displayUserName');
            const userAvatar = document.getElementById('userAvatar');

            // Luôn xóa style inline cũ để tránh lỗi hiển thị menu user
            if (isHeaderLoggedIn && currentHeaderUser.username) {
                signInBtn.style.display = 'none';
                userMenu.style.display = '';
                userMenu.classList.add('visible');                // Update username - prefer fullName over username
                const displayName = currentHeaderUser.fullName || currentHeaderUser.username;
                displayUserName.textContent = displayName;
                
                console.log('🎯 index.html set display name to:', displayName);
                console.log('🎯 currentHeaderUser:', currentHeaderUser);

                // Update avatar - use first letter of fullName if available, else username
                const nameForAvatar = currentHeaderUser.fullName || currentHeaderUser.username;
                const firstLetter = nameForAvatar.charAt(0).toUpperCase();
                userAvatar.src = `data:image/svg+xml;base64,${btoa(`
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="#3498db"/>
                        <text x="20" y="26" text-anchor="middle" font-family="Arial" font-size="16" font-weight="bold" fill="white">${firstLetter}</text>
                    </svg>
                `)}`;
                console.log('🔄 Updated avatar:', firstLetter);
            } else {
                signInBtn.style.display = 'flex';
                userMenu.style.display = 'none';
                userMenu.classList.remove('visible');
            }
            */
        }

        // Header functions
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function viewProfile() {
            window.location.href = './user/user.html';
        }

        function viewBookmarks() {
            alert('Tính năng đang phát triển!');
        }

        function viewHistory() {
            alert('Tính năng đang phát triển!');
        }

        function logout() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                localStorage.clear();
                checkHeaderLoginStatus();
                alert('Đã đăng xuất thành công!');
                window.location.reload();
            }
        }

        // Search functionality
        function setupHeaderSearch() {
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');
            const searchSuggestions = document.getElementById('searchSuggestions');

            if (searchBtn) {
                searchBtn.addEventListener('click', function () {
                    const query = searchInput.value.trim();
                    if (query) {
                        alert(`Tìm kiếm: ${query}`);
                        // Implement search logic here
                    }
                });
            }

            if (searchInput) {
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        searchBtn.click();
                    }
                });
            }
        }

        // Voice search
        function setupVoiceSearch() {
            const voiceBtn = document.getElementById('voiceBtn');
            if (voiceBtn) {
                voiceBtn.addEventListener('click', function () {
                    alert('Tính năng tìm kiếm bằng giọng nói đang phát triển!');
                });
            }
        }

        // Initialize header
        function initializeIntegratedHeader() {
            console.log('🎯 Initializing integrated header...');

            // Check login status immediately
            checkHeaderLoginStatus();

            // Setup search
            setupHeaderSearch();
            setupVoiceSearch();            // Listen for storage changes
            window.addEventListener('storage', function (e) {
                if (e.key === 'username' || e.key === 'token') {
                    console.log('🔄 Storage changed, updating header...');
                    checkHeaderLoginStatus();
                }
            });

            // Auto-check every 10 seconds (reduced frequency)
            // Only check if page is visible to avoid unnecessary calls
            setInterval(() => {
                if (!document.hidden) {
                    checkHeaderLoginStatus();
                }
            }, 10000);

            console.log('✅ Integrated header initialized');
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(initializeIntegratedHeader, 500);
        });

        // Manual refresh function for external use
        window.refreshHeaderStatus = checkHeaderLoginStatus;

        console.log('🎯 Header script loaded');
    </script>

    <!-- Check login status and refresh header -->
    <script>        document.addEventListener('DOMContentLoaded', function () {
            console.log('🏠 Index page loaded, checking login status...');

            // Check if user is logged in
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            console.log('Token:', token ? 'Present' : 'None');
            console.log('Username:', username || 'None');

            // Update header immediately
            updateHeaderLoginStatus();

            if (token && username) {
                console.log('✅ User is logged in:', username);
            } else {
                console.log('❌ User not logged in');
            }
        });
    </script>

    <script>
        // Hiển thị drop menu khi click vào user-info-display
        const userInfoDisplay = document.getElementById('userInfoDisplay');
        const userDropdown = document.getElementById('userDropdown');

        if (userInfoDisplay && userDropdown) {
            userInfoDisplay.addEventListener('click', function (e) {
                e.stopPropagation();
                userDropdown.classList.toggle('active');
            });
            // Ẩn dropdown khi click ra ngoài
            document.addEventListener('click', function (e) {
                if (!userDropdown.contains(e.target) && !userInfoDisplay.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });
        } document.addEventListener('DOMContentLoaded', function () {
            // Update header when page loads
            updateHeaderLoginStatus();

            // Listen for localStorage changes from other tabs
            window.addEventListener('storage', function (e) {
                if (e.key === 'token' || e.key === 'username' || e.key === 'email' || e.key === 'fullName') {
                    updateHeaderLoginStatus();
                }
            });
        });
    </script> <!-- Clean up scripts - use only updateHeaderLoginStatus() -->
    <script>
        // Ensure header is updated when page loads
        window.addEventListener('DOMContentLoaded', function () {
            console.log('== DOMContentLoaded: Calling updateHeaderLoginStatus ==');
            updateHeaderLoginStatus();

            // Log localStorage values for debugging
            console.log('localStorage token:', localStorage.getItem('token'));
            console.log('localStorage username:', localStorage.getItem('username'));

            // Check again after 500ms in case of timing issues
            setTimeout(() => {
                updateHeaderLoginStatus();
            }, 500);
        });

        // Listen for localStorage changes from other tabs
        window.addEventListener('storage', function (e) {
            if (e.key === 'token' || e.key === 'username' || e.key === 'email' || e.key === 'fullName') {
                console.log('== storage event: Calling updateHeaderLoginStatus ==');
                updateHeaderLoginStatus();
            }
        });
    </script>
    <script>
        (function () {
            const bell = document.getElementById('notificationBell');
            const dropdown = document.getElementById('notificationDropdown');
            if (!bell || !dropdown) return;
            // Hiển thị khi hover hoặc click
            let dropdownTimeout;
            function showDropdown() {
                clearTimeout(dropdownTimeout);
                dropdown.classList.add('active');
            }
            function hideDropdown() {
                dropdownTimeout = setTimeout(() => {
                    dropdown.classList.remove('active');
                }, 120);
            }
            bell.addEventListener('mouseenter', showDropdown);
            bell.addEventListener('mouseleave', hideDropdown);
            bell.addEventListener('click', function (e) {
                e.stopPropagation();
                if (dropdown.classList.contains('active')) {
                    dropdown.classList.remove('active');
                } else {
                    showDropdown();
                }
            });
            dropdown.addEventListener('mouseenter', showDropdown);
            dropdown.addEventListener('mouseleave', hideDropdown);
            // Đóng khi click ra ngoài
            document.addEventListener('click', function (e) {
                if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        })();
    </script>
    <script>
        function playBannerMovie() {
            window.location.href = './moive player/moive.html';
        }
    </script>
</body>

</html>